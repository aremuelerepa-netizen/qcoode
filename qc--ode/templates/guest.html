<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Your Ticket ‚Äî QCode</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet"/>
<style>
:root{--ink:#0d1117;--ink2:#1c2333;--accent:#4361ee;--teal:#06d6a0;--amber:#ffbe0b;--rose:#ef233c;--mist:#f0f4ff;--mist2:#e8eeff;--white:#ffffff;--fd:'Plus Jakarta Sans',sans-serif;--fi:'Instrument Serif',serif;--r:10px;--r2:16px;--r3:24px;--sh:0 4px 20px rgba(13,17,23,.12);--shl:0 20px 60px rgba(13,17,23,.2);--t:.2s ease}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--fd);min-height:100vh;background:linear-gradient(135deg,var(--ink2) 0%,#2d3a8c 60%,#0d1117 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem 1rem}
.logo{display:flex;align-items:center;gap:.5rem;font-weight:800;font-size:1.25rem;color:#fff;text-decoration:none;margin-bottom:2rem;letter-spacing:-.03em}
.logo em{color:var(--teal);font-style:normal}
.card{background:var(--white);border-radius:var(--r3);padding:2.5rem;width:100%;max-width:440px;box-shadow:var(--shl)}
.live-badge{display:inline-flex;align-items:center;gap:.375rem;font-size:.7rem;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.1em;background:rgba(6,214,160,.1);border:1px solid rgba(6,214,160,.25);border-radius:999px;padding:.3rem .875rem;margin-bottom:1.5rem}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--teal);animation:blink 1.2s ease infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.called-box{display:none;background:linear-gradient(135deg,#047857,var(--teal));border-radius:var(--r2);padding:1.25rem 1.5rem;margin-bottom:1.5rem;animation:pls 1.5s ease infinite}
@keyframes pls{0%,100%{box-shadow:0 0 0 0 rgba(6,214,160,.4)}50%{box-shadow:0 0 0 16px rgba(6,214,160,0)}}
.called-box h2{font-size:1.1rem;font-weight:800;color:#fff;margin-bottom:.25rem}
.called-box p{font-size:.825rem;color:rgba(255,255,255,.8)}
.svc-lbl{font-size:.65rem;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.12em;margin-bottom:.2rem}
.svc-name{font-weight:800;font-size:1rem;color:var(--ink);margin-bottom:.2rem}
.org-name{font-size:.8rem;color:#64748b;margin-bottom:2rem}
.ticket-lbl{font-size:.65rem;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.12em}
.ticket-num{font-family:var(--fi);font-size:5.5rem;font-weight:800;color:var(--ink);line-height:1;margin:.2rem 0 1.5rem;font-style:italic}
.pill-row{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin-bottom:1.5rem}
.pill{display:inline-flex;align-items:center;gap:.5rem;border-radius:999px;padding:.5rem 1.25rem;font-size:.875rem;font-weight:600}
.pill-pos{background:rgba(67,97,238,.1);border:2px solid rgba(67,97,238,.2);color:var(--accent)}
.pill-eta{background:rgba(6,214,160,.08);border:2px solid rgba(6,214,160,.2);color:#047857}
.exact-time-box{background:linear-gradient(135deg,rgba(255,190,11,.1),rgba(255,190,11,.05));border:2px solid rgba(255,190,11,.25);border-radius:var(--r2);padding:.875rem 1.25rem;text-align:center;margin-bottom:1.25rem}
.et-lbl{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#92400e;margin-bottom:.25rem}
.et-val{font-family:var(--fi);font-size:2rem;font-weight:800;color:var(--ink);font-style:italic}
.et-date{font-size:.75rem;color:#64748b;margin-top:.125rem}
.endcode-box{background:rgba(255,190,11,.1);border:2px solid rgba(255,190,11,.25);border-radius:var(--r);padding:.75rem 1rem;text-align:center;margin-bottom:1.25rem;font-size:.8rem;color:#92400e;font-weight:600}
.divider{height:1px;background:var(--mist2);margin:1.5rem 0}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:.875rem;margin-bottom:1.25rem}
.sg{background:var(--mist);border:1px solid var(--mist2);border-radius:var(--r2);padding:1rem;text-align:center}
.sg-n{font-family:var(--fi);font-size:1.75rem;font-weight:800;color:var(--accent);font-style:italic;line-height:1}
.sg-l{font-size:.65rem;color:#64748b;text-transform:uppercase;letter-spacing:.06em;margin-top:.25rem}
.upd{font-size:.7rem;color:#94a3b8;text-align:center;margin-bottom:1.5rem}
.btn{display:flex;align-items:center;justify-content:center;gap:.4rem;padding:.8rem 1.5rem;border-radius:var(--r);font-family:var(--fd);font-size:.9rem;font-weight:700;cursor:pointer;width:100%;border:none;transition:all var(--t)}
.btn-ghost{background:var(--mist);color:#475569;border:2px solid var(--mist2);margin-bottom:.625rem}.btn-ghost:hover{border-color:var(--rose);color:var(--rose)}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#3451d1}
.cta{background:linear-gradient(135deg,rgba(67,97,238,.06),rgba(114,9,183,.04));border:2px solid rgba(67,97,238,.15);border-radius:var(--r2);padding:1.25rem;margin-top:1.5rem;text-align:center}
.cta h3{font-size:.9rem;font-weight:700;color:var(--ink);margin-bottom:.375rem}
.cta p{font-size:.78rem;color:#64748b;margin-bottom:.875rem;line-height:1.5}
#toasts{position:fixed;top:1.25rem;right:1.25rem;display:flex;flex-direction:column;gap:.5rem;z-index:999}
.toast{padding:.75rem 1rem;border-radius:var(--r);box-shadow:var(--sh);font-size:.825rem;font-weight:600;display:flex;align-items:center;gap:.5rem;border-left:4px solid;animation:tIn .25s ease}
.t-w{background:#fffbeb;border-color:var(--amber);color:#92400e}
@keyframes tIn{from{opacity:0;transform:translateX(1.5rem)}to{opacity:1;transform:none}}
/* Overlay + Modal */
.overlay{position:fixed;inset:0;z-index:400;background:rgba(13,17,23,.6);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:1rem}
.modal{background:var(--white);border-radius:var(--r3);padding:2rem;width:100%;max-width:420px;box-shadow:var(--shl)}
.modal-title{font-size:1.15rem;font-weight:800;color:var(--ink);margin-bottom:1.25rem}
.lbl{font-size:.75rem;font-weight:700;color:#475569;text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:.375rem}
.inp{padding:.8rem 1rem;background:var(--mist);border:2px solid transparent;border-radius:var(--r);font-family:var(--fd);font-size:.9rem;color:var(--ink);width:100%;transition:all var(--t)}
.inp:focus{outline:none;border-color:var(--accent);background:var(--white)}
.inp.code-inp{text-transform:uppercase;letter-spacing:.2em;font-weight:800;text-align:center;font-size:1.1rem}
.ferr{font-size:.78rem;color:var(--rose);margin-top:.375rem;display:none}
.modal-footer{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.25rem}
.stars{display:flex;gap:.375rem;justify-content:center;margin:1rem 0}
.star{font-size:2rem;cursor:pointer;opacity:.3;transition:all .15s}
.star.active{opacity:1}
</style>
</head>
<body>
<a href="/" class="logo">
  <svg width="28" height="28" viewBox="0 0 30 30" fill="none"><rect width="30" height="30" rx="8" fill="#4361ee"/><rect x="7" y="9" width="16" height="3" rx="1.5" fill="white"/><rect x="7" y="14" width="11" height="3" rx="1.5" fill="rgba(255,255,255,.6)"/><rect x="7" y="19" width="7" height="3" rx="1.5" fill="rgba(255,255,255,.35)"/></svg>
  <em>Q</em>Code
</a>

<div class="card" id="main-card">
  <div class="live-badge"><div class="live-dot"></div>Live Tracking</div>
  <div id="called-box" class="called-box"><h2>üì¢ You're Being Called!</h2><p>Please proceed to the service counter now.</p></div>
  <div class="svc-lbl">Service</div>
  <div class="svc-name" id="svc-name">Loading‚Ä¶</div>
  <div class="org-name" id="org-name">‚Äî</div>
  <div class="ticket-lbl">Your Ticket</div>
  <div class="ticket-num" id="ticket-num">‚Äî</div>
  <div class="pill-row">
    <span class="pill pill-pos">Position <strong id="pos-num" style="margin-left:.4rem">‚Äî</strong></span>
    <span class="pill pill-eta">‚è± ETA: <strong id="eta-str" style="margin-left:.4rem">Calculating‚Ä¶</strong></span>
  </div>
  <div class="exact-time-box" id="exact-box" style="display:none">
    <div class="et-lbl">‚è∞ Your estimated turn</div>
    <div class="et-val" id="et-val">‚Äî</div>
    <div class="et-date" id="et-date">‚Äî</div>
  </div>
  <div class="endcode-box" id="endcode-box" style="display:none"></div>
  <div class="divider"></div>
  <div class="stats-grid">
    <div class="sg"><div class="sg-n" id="stat-ahead">‚Äî</div><div class="sg-l">Ahead of You</div></div>
    <div class="sg"><div class="sg-n" id="stat-total">‚Äî</div><div class="sg-l">Total Waiting</div></div>
  </div>
  <div class="upd">Updated: <span id="upd-time">‚Äî</span></div>
  <button class="btn btn-ghost" onclick="leaveQueue()">‚úï Leave Queue</button>
  <div class="cta">
    <h3>Want alerts & history?</h3>
    <p>Create a free account to track all queues, get notifications, and never miss your turn.</p>
    <a href="/register-user" class="btn btn-primary" style="text-decoration:none">Create Free Account ‚Üí</a>
  </div>
</div>

<!-- End Code Modal -->
<div id="modal-endcode" class="overlay" style="display:none">
  <div class="modal">
    <div class="modal-title">‚úÖ It's Your Turn!</div>
    <p style="font-size:.875rem;color:#64748b;margin-bottom:1.25rem;line-height:1.65">Enter the <strong>End Code</strong> from the service staff to confirm you've been served.</p>
    <label class="lbl">End Code</label>
    <input id="end-code-inp" class="inp code-inp" type="text" placeholder="XXXX" maxlength="4"/>
    <div id="end-code-err" class="ferr"></div>
    <div class="modal-footer">
      <button onclick="document.getElementById('modal-endcode').style.display='none'" style="background:var(--mist);border:2px solid var(--mist2);color:#475569;padding:.65rem 1.25rem;border-radius:10px;font-family:var(--fd);font-weight:700;cursor:pointer">Later</button>
      <button onclick="submitEndCode()" style="background:var(--teal);color:var(--ink);border:none;padding:.65rem 1.25rem;border-radius:10px;font-family:var(--fd);font-weight:700;cursor:pointer">Confirm ‚Üí</button>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div id="modal-feedback" class="overlay" style="display:none">
  <div class="modal">
    <div class="modal-title">‚≠ê Rate Your Experience</div>
    <p style="font-size:.875rem;color:#64748b;margin-bottom:.5rem">How was your experience?</p>
    <div class="stars" id="stars-row">
      <span class="star" onclick="setStar(1)">‚òÖ</span>
      <span class="star" onclick="setStar(2)">‚òÖ</span>
      <span class="star" onclick="setStar(3)">‚òÖ</span>
      <span class="star" onclick="setStar(4)">‚òÖ</span>
      <span class="star" onclick="setStar(5)">‚òÖ</span>
    </div>
    <label class="lbl">Comment (optional)</label>
    <textarea id="fb-comment" class="inp" style="resize:vertical;min-height:70px" placeholder="Tell us more‚Ä¶"></textarea>
    <div class="modal-footer">
      <button onclick="document.getElementById('modal-feedback').style.display='none'" style="background:var(--mist);border:2px solid var(--mist2);color:#475569;padding:.65rem 1.25rem;border-radius:10px;font-family:var(--fd);font-weight:700;cursor:pointer">Skip</button>
      <button onclick="submitFeedback()" style="background:var(--accent);color:#fff;border:none;padding:.65rem 1.25rem;border-radius:10px;font-family:var(--fd);font-weight:700;cursor:pointer">Submit</button>
    </div>
  </div>
</div>

<div id="toasts"></div>

<script>
var entry=null,svc=null,pollTimer=null;
var fbRating=0,endCodePrompted=false;

function toast(msg,type,ms){
  type=type||'w';ms=ms||7000;
  var el=document.createElement('div');el.className='toast t-'+type;el.innerHTML='<span>‚ö†</span><span>'+msg+'</span>';
  document.getElementById('toasts').appendChild(el);setTimeout(function(){el.remove();},ms);
}
function fmtTime(ts){if(!ts)return'‚Äî';return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function fmtDate(ts){if(!ts)return'‚Äî';return new Date(ts).toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric'});}

async function api(url,opts){
  try{var r=await fetch(url,{headers:{'Content-Type':'application/json'},...(opts||{})});var d=await r.json().catch(function(){return{};});return{ok:r.ok,data:d};}
  catch(e){return{ok:false,data:{error:'Network error'}};}
}

async function init(){
  var stored=sessionStorage.getItem('guestEntry');
  if(!stored){window.location.href='/';return;}
  try{var p=JSON.parse(stored);entry=p.entry||p;svc={name:entry.svc_name,id:entry.service_id};}
  catch(e){window.location.href='/';return;}
  document.getElementById('ticket-num').textContent=entry.ticket_label||'‚Äî';
  document.getElementById('svc-name').textContent=entry.svc_name||'‚Äî';
  document.getElementById('org-name').textContent=entry.org_name||'';
  if(entry.end_code){
    var eb=document.getElementById('endcode-box');
    eb.textContent='üîë End Code: '+entry.end_code+' (show to staff when done)';
    eb.style.display='';
  }
  await refresh();
  pollTimer=setInterval(refresh,12000);
}

async function refresh(){
  if(!entry)return;
  var r=await api('/api/guest/queue-status/'+entry.id);
  if(!r.ok)return;
  var d=r.data;

  // Handle terminal states
  if(['completed','no_show','cancelled'].includes(d.status)){
    clearInterval(pollTimer);sessionStorage.removeItem('guestEntry');
    var emo=d.status==='completed'?'‚úÖ':'‚ùå';
    var msg=d.status==='completed'?'You were served!':d.status==='no_show'?'Marked as no-show':'You left the queue';
    document.getElementById('main-card').innerHTML='<div style="text-align:center;padding:1.5rem"><div style="font-size:3.5rem;margin-bottom:1rem">'+emo+'</div><h2 style="font-family:\'Plus Jakarta Sans\',sans-serif;font-size:1.5rem;font-weight:800;color:#0d1117;margin-bottom:.875rem">'+msg+'</h2><p style="color:#64748b;line-height:1.65;margin-bottom:2rem">Ticket '+entry.ticket_label+' is now closed.</p><a href="/register-user" style="display:block;padding:.875rem;background:#4361ee;color:#fff;border-radius:10px;font-weight:700;text-decoration:none;text-align:center;margin-bottom:.75rem">Create Free Account</a><a href="/" style="display:block;padding:.875rem;color:#64748b;border:2px solid #e8eeff;border-radius:10px;font-weight:700;text-decoration:none;text-align:center">‚Üê Back to Home</a></div>';
    if(d.status==='completed')setTimeout(function(){document.getElementById('modal-feedback').style.display='flex';},800);
    return;
  }

  var ahead=d.ahead||0;var pos=d.position||1;
  document.getElementById('pos-num').textContent=pos;
  document.getElementById('stat-ahead').textContent=Math.max(0,pos-1);
  document.getElementById('stat-total').textContent=d.total||0;
  document.getElementById('eta-str').textContent='~'+(d.eta_minutes||0)+' min';
  document.getElementById('upd-time').textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});

  if(d.estimated_time){
    var etaDate=new Date(d.estimated_time);
    document.getElementById('et-val').textContent=etaDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    document.getElementById('et-date').textContent=fmtDate(d.estimated_time);
    document.getElementById('exact-box').style.display='';
  }

  // Called
  document.getElementById('called-box').style.display=d.status==='called'?'block':'none';
  if(d.status==='called'&&!endCodePrompted){
    endCodePrompted=true;
    toast('üì¢ You are being called! Go to the counter now.','w',12000);
    setTimeout(function(){document.getElementById('modal-endcode').style.display='flex';},600);
  }
}

async function leaveQueue(){
  if(!confirm('Leave this queue?'))return;
  await api('/api/guest/leave/'+entry.id,{method:'POST'});
  sessionStorage.removeItem('guestEntry');window.location.href='/';
}

async function submitEndCode(){
  var code=document.getElementById('end-code-inp').value.trim().toUpperCase();
  var err=document.getElementById('end-code-err');err.style.display='none';
  if(!code||code.length<4){err.textContent='Enter the 4-character end code.';err.style.display='block';return;}
  // Guest can't call verify-end-code (no session), so just show completion state
  // The org will mark as complete via their dashboard
  document.getElementById('modal-endcode').style.display='none';
  clearInterval(pollTimer);sessionStorage.removeItem('guestEntry');
  toast('Thank you! Staff will confirm your service.','w',5000);
  setTimeout(function(){document.getElementById('modal-feedback').style.display='flex';},800);
}

function setStar(n){
  fbRating=n;
  document.querySelectorAll('.star').forEach(function(s,i){s.classList.toggle('active',i<n);});
}
async function submitFeedback(){
  if(!fbRating){toast('Please select a rating.','w',3000);return;}
  var comment=document.getElementById('fb-comment').value.trim();
  await api('/api/guest/feedback',{method:'POST',body:JSON.stringify({entry_id:entry.id,rating:fbRating,comment:comment})});
  document.getElementById('modal-feedback').style.display='none';
  toast('Thank you for your feedback! ‚≠ê','w',4000);
  setTimeout(function(){window.location.href='/';},2000);
}

init();
</script>
</body>
</html>
