<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>My Dashboard â€” QCode</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
:root{
  --ink:#0d0f14;--ink2:#1e2230;--ink3:#323848;
  --muted:#8892a4;--border:#e4e8f0;--bg:#f4f6fb;--white:#fff;
  --brand:#4361ee;--brand2:#3a0ca3;--cyan:#4cc9f0;--green:#06d6a0;
  --amber:#ffd166;--red:#ef4565;--purple:#7209b7;
  --brand-glow:0 0 0 3px rgba(67,97,238,.18);
  --sh:0 2px 8px rgba(13,15,20,.07);
  --shm:0 6px 24px rgba(13,15,20,.12);
  --shl:0 16px 48px rgba(13,15,20,.16);
  --r:.75rem;--rl:1.25rem;--rxl:1.75rem;
  --fh:'Space Grotesk',sans-serif;--fb:'Plus Jakarta Sans',sans-serif;
  --t:.2s cubic-bezier(.4,0,.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--fb);background:var(--bg);color:var(--ink);min-height:100vh;display:flex;flex-direction:column;font-size:15px}
h1,h2,h3,h4{font-family:var(--fh);line-height:1.15;letter-spacing:-.03em}
a{text-decoration:none;color:var(--brand)}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{background:var(--ink2);height:62px;display:flex;align-items:center;padding:0 1.5rem;gap:1rem;position:sticky;top:0;z-index:100;box-shadow:0 1px 0 rgba(255,255,255,.05)}
.tb-logo{display:flex;align-items:center;gap:.5rem;font-family:var(--fh);font-size:1.15rem;font-weight:700;color:#fff;text-decoration:none}
.tb-logo-dot{width:8px;height:8px;border-radius:50%;background:var(--cyan);margin-left:.25rem;animation:pulse-dot 2s ease infinite}
@keyframes pulse-dot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}
.tb-right{margin-left:auto;display:flex;align-items:center;gap:.625rem}
.tb-chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.7);border-radius:99px;padding:.3rem .875rem;font-size:.78rem;font-weight:500}
.tb-btn{background:none;border:none;cursor:pointer;padding:.4rem .875rem;border-radius:var(--r);font-family:var(--fb);font-size:.8rem;font-weight:600;color:rgba(255,255,255,.65);transition:all var(--t)}
.tb-btn:hover{background:rgba(255,255,255,.1);color:#fff}
.tb-logout{color:#f87171!important}.tb-logout:hover{background:rgba(239,68,68,.15)!important}
.tb-lang{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.7);border-radius:var(--r);padding:.3rem .5rem;font-family:var(--fb);font-size:.75rem;cursor:pointer}

/* â”€â”€ SHELL â”€â”€ */
.shell{display:flex;flex:1;overflow:hidden}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:230px;background:var(--white);border-right:1px solid var(--border);padding:1.25rem 1rem;flex-shrink:0;display:flex;flex-direction:column;gap:.15rem;overflow-y:auto}
.sb-section{font-size:.65rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;padding:.625rem .75rem;margin-top:.625rem}
.sb-item{display:flex;align-items:center;gap:.625rem;padding:.65rem .875rem;border-radius:var(--r);font-size:.85rem;font-weight:500;color:var(--ink3);cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:all var(--t)}
.sb-item:hover{background:var(--bg);color:var(--ink)}
.sb-item.active{background:rgba(67,97,238,.08);color:var(--brand);font-weight:700}
.sb-item .ico{width:20px;text-align:center;font-size:1.05rem}
.sb-divider{height:1px;background:var(--border);margin:.5rem 0}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;padding:2rem 2rem;overflow-y:auto;max-height:calc(100vh - 62px)}

/* â”€â”€ PANELS â”€â”€ */
.panel{display:none;animation:fadeIn .2s ease}
.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* â”€â”€ PH â”€â”€ */
.ph{margin-bottom:1.75rem}
.ph h1{font-size:1.65rem;color:var(--ink);margin-bottom:.25rem}
.ph p{color:var(--muted);font-size:.9rem}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:.65rem 1.375rem;border-radius:var(--r);border:none;font-family:var(--fb);font-size:.875rem;font-weight:600;cursor:pointer;transition:all var(--t);white-space:nowrap}
.btn:disabled{opacity:.45;cursor:not-allowed}
.bp{background:var(--brand);color:#fff}.bp:hover:not(:disabled){background:var(--brand2);transform:translateY(-1px);box-shadow:0 4px 16px rgba(67,97,238,.3)}
.bs{background:var(--green);color:#fff}.bs:hover:not(:disabled){filter:brightness(1.07)}
.bd{background:var(--red);color:#fff}.bd:hover:not(:disabled){filter:brightness(1.07)}
.bg{background:transparent;color:var(--ink3);border:1.5px solid var(--border)}.bg:hover:not(:disabled){border-color:var(--brand);color:var(--brand)}
.btn-full{width:100%;display:flex}
.btn-lg{padding:.9rem 2rem;font-size:1rem}

/* â”€â”€ INPUTS â”€â”€ */
.fg{display:flex;flex-direction:column;gap:.375rem;margin-bottom:1.125rem}
.lbl{font-size:.8rem;font-weight:700;color:var(--ink3)}
.hint{font-size:.74rem;color:var(--muted)}
.inp{padding:.75rem 1rem;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r);font-family:var(--fb);font-size:.9rem;color:var(--ink);width:100%;transition:border-color var(--t),box-shadow var(--t)}
.inp:focus{outline:none;border-color:var(--brand);box-shadow:var(--brand-glow);background:var(--white)}
.inp::placeholder{color:var(--muted)}
select.inp{cursor:pointer}
.code-inp{text-transform:uppercase;letter-spacing:.15em;font-family:var(--fh);font-weight:700;font-size:1.05rem}
.inp-row{display:flex;gap:.625rem}.inp-row .inp{flex:1}
.ferr{font-size:.78rem;color:var(--red);margin-top:.3rem;display:none;padding:.4rem .75rem;background:rgba(239,69,101,.06);border-radius:.4rem;border:1px solid rgba(239,69,101,.2)}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--rl);padding:1.75rem;box-shadow:var(--sh);margin-bottom:1.25rem}
.card-title{font-family:var(--fh);font-size:1rem;font-weight:700;color:var(--ink);margin-bottom:1.25rem}

/* â”€â”€ BADGE â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:.2rem .65rem;border-radius:99px;font-size:.72rem;font-weight:700}
.b-waiting{background:rgba(67,97,238,.1);color:var(--brand)}
.b-called{background:rgba(255,209,102,.15);color:#b45309}
.b-serving{background:rgba(6,214,160,.1);color:#047857}
.b-completed{background:rgba(136,146,164,.1);color:var(--muted)}
.b-no_show{background:rgba(239,69,101,.1);color:var(--red)}
.b-cancelled{background:rgba(136,146,164,.1);color:var(--muted)}
.b-open{background:rgba(6,214,160,.1);color:#047857}
.b-paused{background:rgba(255,209,102,.15);color:#b45309}
.b-closed{background:rgba(239,69,101,.1);color:var(--red)}

/* â”€â”€ TICKET CARD â”€â”€ */
.ticket-hero{background:linear-gradient(135deg,var(--ink2) 0%,var(--brand2) 60%,var(--brand) 100%);border-radius:var(--rxl);color:#fff;text-align:center;padding:2.75rem 2rem;margin-bottom:1.25rem;position:relative;overflow:hidden}
.ticket-hero::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.015) 0,rgba(255,255,255,.015) 1px,transparent 1px,transparent 20px)}
.th-inner{position:relative}
.th-svc{font-size:.72rem;opacity:.55;text-transform:uppercase;letter-spacing:.1em;margin-bottom:.375rem}
.th-label{font-size:.7rem;opacity:.5;text-transform:uppercase;letter-spacing:.1em;margin-top:.25rem}
.th-ticket{font-family:var(--fh);font-size:5.5rem;font-weight:700;line-height:1;letter-spacing:-.04em}
.th-chips{display:flex;justify-content:center;gap:.75rem;flex-wrap:wrap;margin-top:1.25rem}
.th-chip{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:99px;padding:.4rem 1rem;font-size:.8rem;font-weight:600}
.th-chip.cyan{background:rgba(76,201,240,.15);border-color:rgba(76,201,240,.3);color:var(--cyan)}
.th-chip.green{background:rgba(6,214,160,.15);border-color:rgba(6,214,160,.3);color:#34d399}
.th-eta-exact{font-size:.85rem;opacity:.75;margin-top:.75rem}

/* â”€â”€ STATUS BOX â”€â”€ */
.status-alert{border-radius:var(--rl);padding:1.125rem 1.5rem;margin-bottom:1.25rem;border:2px solid transparent;display:flex;align-items:center;gap:1rem;transition:all .3s}
.sa-waiting{background:rgba(67,97,238,.05);border-color:rgba(67,97,238,.12)}
.sa-called{background:rgba(6,214,160,.07);border-color:var(--green);animation:border-pulse 1.5s ease infinite}
.sa-serving{background:rgba(255,209,102,.1);border-color:var(--amber)}
@keyframes border-pulse{0%,100%{box-shadow:0 0 0 0 rgba(6,214,160,.3)}50%{box-shadow:0 0 0 10px rgba(6,214,160,0)}}
.sa-icon{font-size:2rem;flex-shrink:0}
.sa-title{font-family:var(--fh);font-size:1rem;font-weight:700;color:var(--ink)}
.sa-desc{font-size:.82rem;color:var(--muted);margin-top:.125rem;line-height:1.5}

/* â”€â”€ STATS PAIR â”€â”€ */
.stat-pair{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem}
.sp{background:var(--bg);border:1px solid var(--border);border-radius:var(--r);padding:1rem;text-align:center}
.sp-n{font-family:var(--fh);font-size:1.75rem;font-weight:700;color:var(--brand);line-height:1}
.sp-l{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-top:.2rem}

/* â”€â”€ FOUND BOX â”€â”€ */
.found-box{background:rgba(67,97,238,.05);border:1.5px solid rgba(67,97,238,.15);border-radius:var(--r);padding:1rem 1.25rem;margin-bottom:1.125rem}
.found-name{font-weight:700;font-family:var(--fh);color:var(--ink);font-size:1.05rem}
.found-meta{font-size:.78rem;color:var(--muted);margin-top:.375rem;display:flex;gap:1rem;flex-wrap:wrap}

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
thead{border-bottom:2px solid var(--border)}
th{text-align:left;padding:.75rem 1rem;font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em}
td{padding:.875rem 1rem;font-size:.85rem;border-bottom:1px solid var(--bg);color:var(--ink3)}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--bg)}
.ticket-tag{font-family:var(--fh);font-size:.95rem;font-weight:700;color:var(--brand)}

/* â”€â”€ NEARBY â”€â”€ */
.nearby-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
.nb-card{background:var(--white);border:1px solid var(--border);border-radius:var(--rl);padding:1.25rem;cursor:pointer;transition:all var(--t);position:relative;overflow:hidden}
.nb-card::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--brand),var(--cyan));transform:scaleX(0);transition:transform var(--t);transform-origin:left}
.nb-card:hover{border-color:var(--brand);box-shadow:var(--shm);transform:translateY(-2px)}.nb-card:hover::after{transform:scaleX(1)}
.nb-name{font-weight:700;font-family:var(--fh);color:var(--ink);margin-bottom:.25rem}
.nb-meta{font-size:.78rem;color:var(--muted);line-height:1.7}
.nb-code{font-family:var(--fh);font-size:1.1rem;font-weight:700;color:var(--brand);letter-spacing:.1em;margin-top:.5rem}

/* â”€â”€ PROFILE CARD â”€â”€ */
.profile-hero{background:linear-gradient(135deg,var(--ink2),var(--brand2));border-radius:var(--rxl);padding:1.75rem;color:#fff;margin-bottom:1.5rem;display:flex;align-items:center;gap:1.25rem;flex-wrap:wrap}
.avatar{width:54px;height:54px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;font-family:var(--fh);font-size:1.3rem;font-weight:700;flex-shrink:0;border:2.5px solid rgba(255,255,255,.25)}
.pf-name{font-family:var(--fh);font-size:1.05rem;font-weight:700}
.pf-email{font-size:.78rem;opacity:.6;margin-top:.1rem}
.pf-stats{margin-left:auto;text-align:right}
.pf-stat-n{font-family:var(--fh);font-size:1.5rem;font-weight:700}
.pf-stat-l{font-size:.68rem;opacity:.55;text-transform:uppercase;letter-spacing:.07em}

/* â”€â”€ OVERLAY / MODAL â”€â”€ */
.overlay{position:fixed;inset:0;z-index:400;background:rgba(13,15,20,.55);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:1.25rem;animation:ovIn .15s ease}
@keyframes ovIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--white);border-radius:var(--rxl);padding:2rem;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shl);animation:modUp .2s cubic-bezier(.16,1,.3,1)}
@keyframes modUp{from{opacity:0;transform:translateY(1.5rem)}to{opacity:1;transform:none}}
.modal-title{font-family:var(--fh);font-size:1.2rem;font-weight:700;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.modal-footer{display:flex;justify-content:flex-end;gap:.75rem;margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border)}

/* â”€â”€ STAR RATING â”€â”€ */
.stars{display:flex;gap:.5rem;margin-bottom:1.25rem}
.star{font-size:2rem;cursor:pointer;transition:transform .15s;filter:grayscale(1) opacity(.4)}
.star.on{filter:none;transform:scale(1.1)}
.star:hover{transform:scale(1.15)}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:3rem 2rem;color:var(--muted)}
.empty h3{color:var(--ink3);margin-bottom:.375rem;font-size:1.05rem}
.spin{width:20px;height:20px;border:2.5px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin .5s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.loading{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:2.5rem;color:var(--muted)}

/* â”€â”€ FAQ WIDGET â”€â”€ */
#faq-widget{position:fixed;bottom:1.75rem;right:1.75rem;z-index:500}
#faq-fab{display:flex;align-items:center;gap:.5rem;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:99px;padding:.75rem 1.25rem;font-family:var(--fh);font-weight:700;font-size:.875rem;cursor:pointer;box-shadow:0 4px 20px rgba(67,97,238,.4);transition:all var(--t)}
#faq-fab:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(67,97,238,.5)}
.faq-panel{position:absolute;bottom:calc(100% + 1rem);right:0;width:360px;background:var(--white);border:1px solid var(--border);border-radius:var(--rxl);box-shadow:var(--shl);display:flex;flex-direction:column;overflow:hidden;max-height:520px}
.faq-panel.hidden{display:none}
.faq-hdr{display:flex;justify-content:space-between;align-items:center;padding:.875rem 1.25rem;background:linear-gradient(135deg,var(--ink2),var(--brand2));color:#fff}
.faq-hdr-info .t{font-family:var(--fh);font-weight:700;font-size:.9rem}
.faq-hdr-info .s{font-size:.7rem;opacity:.6;margin-top:.05rem}
.faq-hdr-btns{display:flex;gap:.35rem}
.faq-hdr-btns button{background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.75);cursor:pointer;padding:.25rem .5rem;border-radius:.35rem;font-size:.8rem;transition:all var(--t)}
.faq-hdr-btns button:hover{background:rgba(255,255,255,.2);color:#fff}
.faq-msgs{flex:1;padding:1rem;overflow-y:auto;display:flex;flex-direction:column;gap:.75rem;min-height:220px;max-height:280px}
.faq-msg{display:flex}
.faq-msg.user{justify-content:flex-end}
.faq-bubble{max-width:86%;padding:.65rem .9rem;border-radius:var(--rl);font-size:.84rem;line-height:1.55}
.faq-msg.ai .faq-bubble{background:var(--bg);color:var(--ink);border-bottom-left-radius:.25rem}
.faq-msg.user .faq-bubble{background:var(--brand);color:#fff;border-bottom-right-radius:.25rem}
.faq-quickbtns{display:flex;gap:.4rem;padding:.625rem 1rem;flex-wrap:wrap;border-top:1px solid var(--border);background:var(--bg)}
.faq-qb{background:var(--white);border:1.5px solid var(--border);color:var(--ink3);padding:.28rem .65rem;border-radius:99px;font-size:.72rem;cursor:pointer;transition:all var(--t);font-family:var(--fb)}
.faq-qb:hover{border-color:var(--brand);color:var(--brand)}
.faq-input-row{display:flex;gap:.5rem;padding:.75rem 1rem;border-top:1px solid var(--border)}
.faq-input-row input{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r);padding:.5rem .75rem;font-size:.84rem;color:var(--ink);font-family:var(--fb);outline:none;transition:border-color var(--t)}
.faq-input-row input:focus{border-color:var(--brand)}
#faq-send{background:var(--brand);color:#fff;border:none;border-radius:var(--r);width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all var(--t)}
#faq-send:hover{background:var(--brand2)}
#faq-send:disabled{opacity:.5}

/* â”€â”€ TOASTS â”€â”€ */
#toasts{position:fixed;top:1.25rem;right:1.25rem;display:flex;flex-direction:column;gap:.625rem;z-index:9999;pointer-events:none}
.toast{padding:.75rem 1.125rem;border-radius:.625rem;box-shadow:var(--shl);font-size:.825rem;font-weight:600;display:flex;align-items:center;gap:.5rem;pointer-events:all;min-width:220px;animation:tIn .25s ease}
.t-s{background:#f0fdf4;border-left:3px solid var(--green);color:#047857}
.t-e{background:#fef2f2;border-left:3px solid var(--red);color:#b91c1c}
.t-i{background:#eff6ff;border-left:3px solid var(--brand);color:#1d4ed8}
.t-w{background:#fffbeb;border-left:3px solid var(--amber);color:#92400e}
@keyframes tIn{from{opacity:0;transform:translateX(1.5rem)}to{opacity:1;transform:none}}

/* â”€â”€ MISC â”€â”€ */
.divider{display:flex;align-items:center;gap:.875rem;margin:1.25rem 0;color:var(--muted);font-size:.78rem}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

@media(max-width:860px){.shell{flex-direction:column}.sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border);flex-direction:row;flex-wrap:wrap;padding:.75rem}}
@media(max-width:620px){.main{padding:1rem}.th-ticket{font-size:3.5rem}.faq-panel{width:calc(100vw - 3.5rem)}}
</style>
</head>
<body>

<div class="topbar">
  <a href="/" class="tb-logo">
    <svg width="26" height="26" viewBox="0 0 30 30" fill="none"><rect width="30" height="30" rx="7" fill="#4361ee"/><rect x="7" y="9" width="16" height="3" rx="1.5" fill="white"/><rect x="7" y="14" width="11" height="3" rx="1.5" fill="#a8c8ff"/><rect x="7" y="19" width="7" height="3" rx="1.5" fill="#7ea8ff"/></svg>
    QCode<span class="tb-logo-dot"></span>
  </a>
  <div class="tb-right">
    <span class="tb-chip" id="tb-name">â€”</span>
    <select class="tb-lang" onchange="changeLang(this.value)" id="lang-sel">
      <option value="en">EN</option><option value="fr">FR</option><option value="ar">AR</option><option value="es">ES</option><option value="pt">PT</option>
    </select>
    <button class="tb-btn tb-logout" onclick="doLogout()">Sign out</button>
  </div>
</div>

<div class="shell">
  <div class="sidebar">
    <div class="sb-section">Queue</div>
    <button class="sb-item active" onclick="show('join')"    id="nav-join">   <span class="ico">ğŸ«</span> Join Queue</button>
    <button class="sb-item"        onclick="show('active')"  id="nav-active"> <span class="ico">ğŸ“¡</span> Active Queue <span id="active-badge" style="display:none;margin-left:auto;width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse-dot 2s ease infinite"></span></button>
    <div class="sb-section">History</div>
    <button class="sb-item" onclick="show('history')" id="nav-history"><span class="ico">ğŸ•</span> My History</button>
    <button class="sb-item" onclick="show('nearby')"  id="nav-nearby"> <span class="ico">ğŸ—º</span> Open Services</button>
    <div class="sb-divider"></div>
    <button class="sb-item" onclick="show('account')" id="nav-account"><span class="ico">ğŸ‘¤</span> Account</button>
  </div>

  <div class="main">

    <!-- â•â•â• JOIN â•â•â• -->
    <div class="panel active" id="panel-join">
      <div class="ph"><h1>Join a Queue</h1><p>Enter the service code given to you by the organization</p></div>
      <div class="card">
        <div class="card-title">ğŸ« Service Code Lookup</div>
        <div id="step-code">
          <div class="inp-row">
            <input id="code-in" class="inp code-inp" type="text" placeholder="e.g. VISA24" maxlength="8" autocomplete="off"/>
            <button class="btn bp" onclick="findService()" id="find-btn">Search</button>
          </div>
          <span id="code-err" class="ferr"></span>
        </div>
        <div id="step-found" style="display:none;margin-top:1.25rem">
          <div class="found-box">
            <div class="found-name" id="found-name"></div>
            <div class="found-meta">
              <span id="found-org"></span>
              <span id="found-staff"></span>
              <span id="found-eta"></span>
              <span id="found-waiting"></span>
            </div>
          </div>
          <div id="custom-form-wrap" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:var(--r);padding:1.25rem;margin-bottom:1.125rem">
            <div style="font-family:var(--fh);font-size:.85rem;font-weight:700;color:var(--ink);margin-bottom:.875rem">Please fill in the required information</div>
            <div id="custom-form-fields"></div>
          </div>
          <button class="btn bs btn-full btn-lg" onclick="confirmJoin()" id="join-btn">âœ“ Join This Queue</button>
          <button class="btn bg btn-full" onclick="cancelFind()" style="margin-top:.625rem">â† Cancel</button>
        </div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,rgba(76,201,240,.07),rgba(67,97,238,.05));border-color:rgba(76,201,240,.2)">
        <div style="display:flex;align-items:center;gap:1rem">
          <div style="font-size:2rem">ğŸ“±</div>
          <div>
            <div style="font-weight:700;font-family:var(--fh);color:var(--ink);margin-bottom:.25rem">Join by SMS â€” no internet needed</div>
            <div style="font-size:.82rem;color:var(--muted);line-height:1.5">Text your service code to <strong style="color:var(--brand)" id="sms-num">+2349155189936</strong> to get your ticket instantly</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• ACTIVE â•â•â• -->
    <div class="panel" id="panel-active">
      <div class="ph"><h1>Active Queue</h1><p>Your real-time position and wait time</p></div>
      <div id="no-active" class="card">
        <div class="empty">
          <div style="font-size:3rem;margin-bottom:.75rem">â°</div>
          <h3>Not in any queue</h3>
          <p>Go to "Join Queue" to enter a service code.</p>
          <button class="btn bp" onclick="show('join')" style="margin-top:1.25rem">Join a Queue â†’</button>
        </div>
      </div>
      <div id="active-view" style="display:none">
        <div style="background:var(--ink2);border-radius:var(--rl);padding:1.125rem 1.5rem;margin-bottom:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem">
          <div>
            <div style="font-family:var(--fh);font-size:1.05rem;font-weight:700;color:#fff" id="a-svc-name">â€”</div>
            <div style="font-size:.78rem;color:rgba(255,255,255,.5);margin-top:.1rem" id="a-org-name">â€”</div>
          </div>
          <span class="badge" id="a-svc-status"></span>
        </div>
        <div class="status-alert sa-waiting" id="status-alert">
          <div class="sa-icon" id="sa-icon">â³</div>
          <div><div class="sa-title" id="sa-title">Waiting in queue</div><div class="sa-desc" id="sa-desc">Your position updates automatically.</div></div>
        </div>
        <div class="ticket-hero">
          <div class="th-inner">
            <div class="th-svc" id="th-svc">â€”</div>
            <div class="th-label">Your Ticket</div>
            <div class="th-ticket" id="th-ticket">â€”</div>
            <div class="th-chips">
              <span class="th-chip cyan">Position <span id="th-pos">â€”</span></span>
              <span class="th-chip green">~<span id="th-eta-min">â€”</span> min wait</span>
            </div>
            <div class="th-eta-exact" id="th-eta-exact">Calculating your turn timeâ€¦</div>
          </div>
        </div>
        <div class="stat-pair">
          <div class="sp"><div class="sp-n" id="sp-ahead">â€”</div><div class="sp-l">Ahead of You</div></div>
          <div class="sp"><div class="sp-n" id="sp-total">â€”</div><div class="sp-l">Total Waiting</div></div>
        </div>
        <div id="end-code-section" style="display:none;margin-bottom:1.25rem">
          <div class="card" style="border-color:var(--amber);background:rgba(255,209,102,.06)">
            <div style="font-family:var(--fh);font-size:.9rem;font-weight:700;color:var(--ink);margin-bottom:.5rem">ğŸ”‘ Enter End Code</div>
            <p style="font-size:.82rem;color:var(--muted);margin-bottom:.875rem;line-height:1.5">The staff will give you a 6-character end code. Enter it to complete your visit.</p>
            <div class="inp-row">
              <input id="end-code-inp" class="inp code-inp" type="text" placeholder="XXXXXX" maxlength="6"/>
              <button class="btn bp" onclick="submitEndCode()">Verify</button>
            </div>
          </div>
        </div>
        <button class="btn bd btn-full btn-lg" id="leave-btn" onclick="leaveQueue()">Leave Queue</button>
      </div>
    </div>

    <!-- â•â•â• HISTORY â•â•â• -->
    <div class="panel" id="panel-history">
      <div class="ph"><h1>My History</h1><p>Every queue you have ever joined</p></div>
      <div class="card"><div class="tbl-wrap"><table>
        <thead><tr><th>Ticket</th><th>Service</th><th>Organization</th><th>Method</th><th>Status</th><th>Joined</th></tr></thead>
        <tbody id="hist-tbody"><tr><td colspan="6"><div class="loading"><div class="spin"></div>Loadingâ€¦</div></td></tr></tbody>
      </table></div></div>
    </div>

    <!-- â•â•â• NEARBY â•â•â• -->
    <div class="panel" id="panel-nearby">
      <div class="ph"><h1>Open Services</h1><p>All live queues you can join right now</p></div>
      <div id="nearby-grid" class="nearby-grid"><div class="loading"><div class="spin"></div> Loadingâ€¦</div></div>
    </div>

    <!-- â•â•â• ACCOUNT â•â•â• -->
    <div class="panel" id="panel-account">
      <div class="ph"><h1>My Account</h1></div>
      <div class="profile-hero" id="profile-hero"></div>
      <div class="card" style="max-width:520px">
        <div class="card-title">Settings</div>
        <div class="fg"><label class="lbl">Full Name</label><input id="acc-name" class="inp" type="text"/></div>
        <div class="fg"><label class="lbl">Phone Number</label><input id="acc-phone" class="inp" type="tel" placeholder="+1 234 567 8900"/><span class="hint">For SMS queue updates</span></div>
        <div class="fg"><label class="lbl">Preferred Language</label>
          <select id="acc-lang" class="inp">
            <option value="en">English</option><option value="fr">FranÃ§ais</option><option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option><option value="es">EspaÃ±ol</option><option value="pt">PortuguÃªs</option>
          </select>
        </div>
        <button class="btn bp" onclick="saveAccount()">Save Changes</button>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /shell -->

<!-- â•â•â• NOTIFY MODAL â•â•â• -->
<div id="notify-modal" class="overlay" style="display:none">
  <div class="modal">
    <div class="modal-title">ğŸ”” Queue Notifications</div>
    <p style="color:var(--muted);font-size:.875rem;margin-bottom:1.5rem;line-height:1.6">Would you like to be notified before your turn? We'll alert you so you don't miss it.</p>
    <div class="fg">
      <label class="lbl">Notify me when</label>
      <select id="notify-min" class="inp">
        <option value="2">2 minutes before my turn</option>
        <option value="5" selected>5 minutes before my turn</option>
        <option value="10">10 minutes before my turn</option>
        <option value="15">15 minutes before my turn</option>
      </select>
    </div>
    <div class="fg">
      <label class="lbl">Notification method</label>
      <select id="notify-method" class="inp">
        <option value="push">Browser notification (push)</option>
        <option value="sms">SMS to my phone</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn bg" onclick="skipNotify()">No thanks</button>
      <button class="btn bp" onclick="enableNotify()">Yes, notify me</button>
    </div>
  </div>
</div>

<!-- â•â•â• FEEDBACK MODAL â•â•â• -->
<div id="feedback-modal" class="overlay" style="display:none">
  <div class="modal">
    <div class="modal-title">â­ Rate Your Experience</div>
    <p style="color:var(--muted);font-size:.875rem;margin-bottom:1.25rem;line-height:1.6">How was your experience at <strong id="fb-svc-name">this service</strong>? Your feedback helps improve the service.</p>
    <div class="stars" id="stars">
      <span class="star" onclick="setStar(1)" data-v="1">â­</span>
      <span class="star" onclick="setStar(2)" data-v="2">â­</span>
      <span class="star" onclick="setStar(3)" data-v="3">â­</span>
      <span class="star" onclick="setStar(4)" data-v="4">â­</span>
      <span class="star" onclick="setStar(5)" data-v="5">â­</span>
    </div>
    <div class="fg"><label class="lbl">Comments (optional)</label><textarea id="fb-comment" class="inp" rows="3" placeholder="Tell us what you thinkâ€¦" style="resize:vertical"></textarea></div>
    <div class="modal-footer">
      <button class="btn bg" onclick="closeFeedback()">Skip</button>
      <button class="btn bp" onclick="submitFeedback()">Submit Feedback</button>
    </div>
  </div>
</div>

<!-- â•â•â• END CODE PROMPT MODAL â•â•â• -->
<div id="endcode-modal" class="overlay" style="display:none">
  <div class="modal" style="max-width:400px">
    <div class="modal-title">ğŸ It's Your Turn!</div>
    <p style="color:var(--muted);font-size:.875rem;margin-bottom:1.25rem;line-height:1.6">The staff should give you a 6-character <strong>End Code</strong>. Enter it here to complete your session.</p>
    <div class="fg">
      <label class="lbl">End Code</label>
      <input id="ec-inp" class="inp code-inp" type="text" placeholder="XXXXXX" maxlength="6"/>
    </div>
    <div class="modal-footer">
      <button class="btn bg" onclick="document.getElementById('endcode-modal').style.display='none'">Later</button>
      <button class="btn bs" onclick="submitEndCodeModal()">Verify & Complete</button>
    </div>
  </div>
</div>

<!-- â•â•â• FAQ WIDGET â•â•â• -->
<div id="faq-widget">
  <button id="faq-fab" onclick="toggleFAQ()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    Ask AI
  </button>
  <div class="faq-panel hidden" id="faq-panel">
    <div class="faq-hdr">
      <div style="display:flex;align-items:center;gap:.625rem">
        <span style="font-size:1.4rem">ğŸ¤–</span>
        <div class="faq-hdr-info"><div class="t">QCode AI</div><div class="s">Powered by Llama Â· Always on</div></div>
      </div>
      <div class="faq-hdr-btns">
        <button onclick="clearFAQ()" title="Clear chat">â†º</button>
        <button onclick="toggleFAQ()" title="Close">âœ•</button>
      </div>
    </div>
    <div class="faq-msgs" id="faq-msgs">
      <div class="faq-msg ai"><div class="faq-bubble">ğŸ‘‹ Hi! I'm your QCode AI assistant.<br><br>I can help with joining queues, understanding your wait time, service codes, SMS joining, and more.<br><br>What can I help you with?</div></div>
    </div>
    <div class="faq-quickbtns">
      <button class="faq-qb" onclick="quickQ('How do I join a queue?')">How to join</button>
      <button class="faq-qb" onclick="quickQ('What is a service code?')">Service codes</button>
      <button class="faq-qb" onclick="quickQ('How does SMS joining work?')">SMS joining</button>
      <button class="faq-qb" onclick="quickQ('How does the end code work?')">End code</button>
    </div>
    <div class="faq-input-row">
      <input type="text" id="faq-inp" placeholder="Type your questionâ€¦" onkeydown="if(event.key==='Enter')sendFAQ()"/>
      <button id="faq-send" onclick="sendFAQ()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>

<div id="toasts"></div>

{% raw %}
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(url, opts) {
  try {
    const r = await fetch(url, {
      headers: {'Content-Type': 'application/json'},
      credentials: 'include',
      ...opts,
      body: opts && opts.body && typeof opts.body === 'object' ? JSON.stringify(opts.body) : (opts && opts.body),
    });
    const data = await r.json().catch(() => ({}));
    return {ok: r.ok, status: r.status, data};
  } catch(e) {
    return {ok: false, status: 0, data: {error: 'Network error. Check your connection.'}};
  }
}

function toast(msg, type='i', ms=4500) {
  const icons = {s:'âœ“', e:'âœ•', i:'â„¹', w:'âš '};
  const el = document.createElement('div');
  el.className = `toast t-${type}`;
  el.innerHTML = `<span>${icons[type]||'â„¹'}</span><span>${msg}</span>`;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), ms);
}

function fmt(ts) { if(!ts) return 'â€”'; const d=new Date(ts); return d.toLocaleDateString()+' '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function fmtExact(ts) { if(!ts) return ''; const d=new Date(ts); return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit', hour12:true}); }
function badge(s) {
  const m={waiting:'b-waiting',called:'b-called',serving:'b-serving',completed:'b-completed',no_show:'b-no_show',cancelled:'b-cancelled'};
  return `<span class="badge ${m[s]||''}">${(s||'').replace('_',' ')}</span>`;
}
function changeLang(l) { localStorage.setItem('qcode_lang',l); document.documentElement.lang=l; document.documentElement.dir=l==='ar'?'rtl':'ltr'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE  â€” persisted to sessionStorage so page refresh keeps queue
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let profile = null;
let activeEntry = null;
let foundSvc = null;
let pollTimer = null;
let notifyTimer = null;
let pendingEntryId = null; // for notify modal
let feedbackEntryId = null;
let feedbackSvcName = null;
let starRating = 0;
let faqHistory = [];
let notifyEnabled = false;
let notifyMinutes = 5;

function saveActiveEntry() {
  if (activeEntry) sessionStorage.setItem('qc_active', JSON.stringify(activeEntry));
  else sessionStorage.removeItem('qc_active');
}
function loadActiveEntry() {
  try { const s = sessionStorage.getItem('qc_active'); if(s) activeEntry = JSON.parse(s); } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  const session = await api('/api/auth/me');
  if (!session.ok || !session.data.logged_in) { window.location.href = '/login-user'; return; }
  if (session.data.role !== 'user') {
    window.location.href = session.data.role === 'organization' ? '/org' : '/super-admin';
    return;
  }
  const pr = await api('/api/user/profile');
  if (!pr.ok) { window.location.href = '/login-user'; return; }
  profile = pr.data;

  document.getElementById('tb-name').textContent = profile.full_name || profile.email || 'â€”';
  document.getElementById('acc-name').value  = profile.full_name  || '';
  document.getElementById('acc-phone').value = profile.phone      || '';
  document.getElementById('acc-lang').value  = profile.preferred_lang || 'en';

  const lang = profile.preferred_lang || localStorage.getItem('qcode_lang') || 'en';
  changeLang(lang);
  document.getElementById('lang-sel').value = lang;

  const initials = (profile.full_name || profile.email || 'U').split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('profile-hero').innerHTML =
    `<div class="avatar">${initials}</div>
     <div><div class="pf-name">${profile.full_name || profile.email}</div>
     <div class="pf-email">${profile.email}</div>
     ${profile.phone ? `<div class="pf-email">ğŸ“ ${profile.phone}</div>` : ''}</div>
     <div class="pf-stats"><div class="pf-stat-n">${profile.total_queues||0}</div><div class="pf-stat-l">Total Queues</div></div>`;

  // Restore active queue from session storage
  loadActiveEntry();
  if (activeEntry) {
    document.getElementById('active-badge').style.display = 'inline-block';
    renderActiveView();
    startPolling();
  }

  loadHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if (name==='history') loadHistory();
  if (name==='nearby')  loadNearby();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIND SERVICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function findService() {
  const code = document.getElementById('code-in').value.trim().toUpperCase();
  const err  = document.getElementById('code-err');
  const btn  = document.getElementById('find-btn');
  err.style.display = 'none';
  if (!code) { err.textContent='Please enter a service code.'; err.style.display='block'; return; }

  btn.disabled = true; btn.textContent = 'â€¦';
  const r = await api('/api/user/find-service?code=' + encodeURIComponent(code));
  btn.disabled = false; btn.textContent = 'Search';

  if (!r.ok) { err.textContent = r.data.error || 'Service not found.'; err.style.display='block'; return; }
  foundSvc = r.data;

  document.getElementById('found-name').textContent    = r.data.name;
  document.getElementById('found-org').textContent     = r.data.org_name   ? `ğŸ¢ ${r.data.org_name}`   : '';
  document.getElementById('found-staff').textContent   = r.data.staff_name ? `ğŸ‘¤ ${r.data.staff_name}` : '';
  document.getElementById('found-eta').textContent     = `â± ~${r.data.eta_minutes||0} min wait`;
  document.getElementById('found-waiting').textContent = `ğŸ‘¥ ${r.data.waiting_count||0} waiting`;
  document.getElementById('step-code').style.display  = 'none';
  document.getElementById('step-found').style.display = 'block';

  let fields = [];
  try { fields = JSON.parse(r.data.user_info_form || '[]'); } catch(e) {}
  if (fields.length) {
    document.getElementById('custom-form-wrap').style.display = 'block';
    document.getElementById('custom-form-fields').innerHTML = fields.map(f => `
      <div class="fg"><label class="lbl">${f.label}${f.required?' *':''}</label>
        ${f.type==='textarea'
          ? `<textarea id="cf-${f.id}" class="inp" rows="3"></textarea>`
          : f.type==='select'
          ? `<select id="cf-${f.id}" class="inp"><option value="">Selectâ€¦</option>${(f.options||[]).map(o=>`<option>${o}</option>`).join('')}</select>`
          : `<input id="cf-${f.id}" class="inp" type="${f.type||'text'}"/>`}
      </div>`).join('');
  }
}

function cancelFind() {
  foundSvc = null;
  document.getElementById('step-found').style.display = 'none';
  document.getElementById('step-code').style.display  = 'block';
  document.getElementById('code-in').value = '';
  document.getElementById('custom-form-wrap').style.display = 'none';
  document.getElementById('code-err').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIRM JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function confirmJoin() {
  if (!foundSvc) return;
  const formData = {};
  try {
    const fields = JSON.parse(foundSvc.user_info_form || '[]');
    for (const f of fields) {
      const el = document.getElementById(`cf-${f.id}`);
      if (!el) continue;
      if (f.required && !el.value) { toast(`"${f.label}" is required.`, 'e'); return; }
      formData[f.id] = {label: f.label, value: el.value};
    }
  } catch(e) {}

  const btn = document.getElementById('join-btn');
  btn.disabled = true; btn.textContent = 'Joiningâ€¦';

  const r = await api('/api/user/join-queue', {method:'POST', body:{service_id: foundSvc.id, custom_form_data: formData}});
  btn.disabled = false; btn.textContent = 'âœ“ Join This Queue';

  if (!r.ok) { toast(r.data.error || 'Failed to join queue.', 'e'); return; }
  activeEntry = r.data.entry;
  saveActiveEntry();
  cancelFind();
  renderActiveView();
  show('active');
  toast("You've joined the queue! ğŸ«", 's');
  startPolling();
  document.getElementById('active-badge').style.display = 'inline-block';

  // Show notify modal
  pendingEntryId = activeEntry.id;
  document.getElementById('notify-modal').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFY MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enableNotify() {
  notifyEnabled  = true;
  notifyMinutes  = parseInt(document.getElementById('notify-min').value);
  const method   = document.getElementById('notify-method').value;
  if (method === 'push') {
    Notification.requestPermission().then(perm => {
      if (perm !== 'granted') toast('Browser notifications blocked. Polling instead.', 'w');
    });
  }
  document.getElementById('notify-modal').style.display = 'none';
  toast(`We'll notify you ${notifyMinutes} min before your turn!`, 's');
  // Update entry on server
  if (activeEntry) api('/api/user/join-queue', {}); // no-op â€” notification is client-side
}
function skipNotify() { document.getElementById('notify-modal').style.display = 'none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ACTIVE VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderActiveView() {
  if (!activeEntry) return;
  document.getElementById('no-active').style.display  = 'none';
  document.getElementById('active-view').style.display = 'block';
  document.getElementById('a-svc-name').textContent   = activeEntry.svc_name  || 'â€”';
  document.getElementById('a-org-name').textContent   = activeEntry.org_name  || '';
  document.getElementById('th-svc').textContent       = activeEntry.svc_name  || '';
  document.getElementById('th-ticket').textContent    = activeEntry.ticket_label || 'â€”';
  const sb = document.getElementById('a-svc-status');
  sb.textContent = activeEntry.svc_status || 'open';
  sb.className   = `badge b-${activeEntry.svc_status||'open'}`;
  updateStatusUI(activeEntry);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLL STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshStatus() {
  if (!activeEntry) return;
  const r = await api('/api/user/queue-status/' + activeEntry.id);
  if (!r.ok) return;
  const d = r.data;
  activeEntry = {...activeEntry, ...d};
  saveActiveEntry();

  // Terminal states
  if (['completed','cancelled','no_show'].includes(d.status)) {
    clearInterval(pollTimer);
    document.getElementById('active-badge').style.display = 'none';
    if (d.status === 'completed') {
      // Show feedback modal
      feedbackEntryId = activeEntry.id;
      feedbackSvcName = activeEntry.svc_name;
      document.getElementById('fb-svc-name').textContent = feedbackSvcName || 'this service';
      document.getElementById('feedback-modal').style.display = 'flex';
    }
    activeEntry = null;
    saveActiveEntry();
    document.getElementById('no-active').style.display  = 'block';
    document.getElementById('active-view').style.display = 'none';
    toast(d.status==='completed' ? 'âœ… You were served!' : 'âŒ Queue session ended.', d.status==='completed'?'s':'i');
    return;
  }

  updateStatusUI(d);

  // Show end code input if called
  document.getElementById('end-code-section').style.display = d.status === 'called' ? 'block' : 'none';

  // Prompt end code modal if just called and haven't shown it
  if (d.status === 'called' && !sessionStorage.getItem('ec_shown_'+activeEntry.id)) {
    sessionStorage.setItem('ec_shown_'+activeEntry.id, '1');
    document.getElementById('endcode-modal').style.display = 'flex';
  }

  // Notify before turn
  if (notifyEnabled && d.eta_minutes <= notifyMinutes && d.eta_minutes > 0 && !sessionStorage.getItem('notified_'+activeEntry.id)) {
    sessionStorage.setItem('notified_'+activeEntry.id, '1');
    if (Notification.permission === 'granted') {
      new Notification('QCode: Your turn is coming!', {
        body: `You're ${d.eta_minutes} min away from being served at ${activeEntry.svc_name}.`,
        icon: '/static/icon.png'
      });
    }
    toast(`ğŸ”” Your turn in ~${d.eta_minutes} minutes!`, 'w', 8000);
  }
}

function updateStatusUI(d) {
  const pos  = d.position || 1;
  const mins = d.eta_minutes || 0;
  const etaTS= d.eta_time || d.estimated_time;

  document.getElementById('th-pos').textContent       = pos;
  document.getElementById('th-eta-min').textContent   = mins;
  document.getElementById('sp-ahead').textContent     = Math.max(0, pos-1);
  document.getElementById('sp-total').textContent     = d.total || 0;
  document.getElementById('th-eta-exact').textContent = etaTS ? `Your turn at approximately ${fmtExact(etaTS)}` : '';

  const alert = document.getElementById('status-alert');
  const icon  = document.getElementById('sa-icon');
  const title = document.getElementById('sa-title');
  const desc  = document.getElementById('sa-desc');
  alert.className = 'status-alert';

  if (d.status === 'called') {
    alert.classList.add('sa-called');
    icon.textContent  = 'ğŸ“¢';
    title.textContent = "You're being called!";
    desc.textContent  = 'Please proceed to the service counter immediately.';
  } else if (d.status === 'serving') {
    alert.classList.add('sa-serving');
    icon.textContent  = 'âœ…';
    title.textContent = 'You are being served';
    desc.textContent  = 'You are currently at the counter.';
  } else {
    alert.classList.add('sa-waiting');
    if (pos === 1) { icon.textContent='ğŸ””'; title.textContent="You're next!"; desc.textContent='Stand by â€” you will be called very soon.'; }
    else if (pos <= 3) { icon.textContent='â°'; title.textContent='Almost your turn'; desc.textContent=`Only ${pos-1} person(s) ahead of you.`; }
    else { icon.textContent='â³'; title.textContent='Waiting in queue'; desc.textContent=`Position ${pos} â€” updates automatically every 15s.`; }
  }

  const sb = document.getElementById('a-svc-status');
  if (d.svc_status) { sb.textContent = d.svc_status; sb.className = `badge b-${d.svc_status}`; }
}

function startPolling() {
  clearInterval(pollTimer);
  pollTimer = setInterval(refreshStatus, 15000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEAVE QUEUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function leaveQueue() {
  if (!activeEntry || !confirm('Leave this queue?')) return;
  const btn = document.getElementById('leave-btn');
  btn.disabled = true;
  const r = await api('/api/user/leave-queue/' + activeEntry.id, {method:'POST'});
  btn.disabled = false;
  if (!r.ok) { toast(r.data.error||'Error leaving queue.','e'); return; }
  clearInterval(pollTimer);
  activeEntry = null; saveActiveEntry();
  document.getElementById('active-badge').style.display = 'none';
  document.getElementById('no-active').style.display   = 'block';
  document.getElementById('active-view').style.display = 'none';
  toast('You have left the queue.', 'i');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END CODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitEndCode() { await _doEndCode(document.getElementById('end-code-inp').value); }
async function submitEndCodeModal() { await _doEndCode(document.getElementById('ec-inp').value); document.getElementById('endcode-modal').style.display='none'; }

async function _doEndCode(code) {
  if (!activeEntry) return;
  const c = (code||'').trim().toUpperCase();
  if (c.length < 6) { toast('Please enter the 6-character end code.','e'); return; }
  const r = await api('/api/user/verify-end-code', {method:'POST', body:{entry_id: activeEntry.id, end_code: c}});
  if (!r.ok) { toast(r.data.error||'Invalid code.','e'); return; }
  clearInterval(pollTimer);
  feedbackEntryId = activeEntry.id;
  feedbackSvcName = activeEntry.svc_name;
  activeEntry = null; saveActiveEntry();
  document.getElementById('active-badge').style.display = 'none';
  document.getElementById('no-active').style.display   = 'block';
  document.getElementById('active-view').style.display = 'none';
  document.getElementById('fb-svc-name').textContent = feedbackSvcName || 'this service';
  document.getElementById('feedback-modal').style.display = 'flex';
  toast('âœ… Visit completed!', 's');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStar(n) {
  starRating = n;
  document.querySelectorAll('.star').forEach((s,i) => s.classList.toggle('on', i < n));
}
async function submitFeedback() {
  if (!starRating) { toast('Please select a rating.','e'); return; }
  const comment = document.getElementById('fb-comment').value.trim();
  await api('/api/user/feedback', {method:'POST', body:{entry_id: feedbackEntryId, rating: starRating, comment}});
  closeFeedback();
  toast('Thank you for your feedback! ğŸ™', 's');
}
function closeFeedback() {
  document.getElementById('feedback-modal').style.display = 'none';
  starRating = 0;
  document.querySelectorAll('.star').forEach(s => s.classList.remove('on'));
  document.getElementById('fb-comment').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHistory() {
  const r  = await api('/api/user/history');
  const tb = document.getElementById('hist-tbody');
  if (!r.ok || !r.data.length) {
    tb.innerHTML='<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--muted)">No history yet.</td></tr>';
    return;
  }
  tb.innerHTML = r.data.map(e => `<tr>
    <td><span class="ticket-tag">${e.ticket_label||'â€”'}</span></td>
    <td>${e.svc_name||'â€”'}</td>
    <td>${e.org_name||'â€”'}</td>
    <td>${e.join_method==='sms'?'ğŸ“± SMS':'ğŸŒ Web'}</td>
    <td>${badge(e.status)}</td>
    <td style="font-size:.78rem">${fmt(e.joined_at)}</td>
  </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEARBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadNearby() {
  const r    = await api('/api/user/open-services');
  const grid = document.getElementById('nearby-grid');
  if (!r.ok || !r.data.length) {
    grid.innerHTML='<div class="empty"><h3>No open services right now</h3><p>Check back later.</p></div>';
    return;
  }
  grid.innerHTML = r.data.map(s => `
    <div class="nb-card" onclick="prefillCode('${s.service_code}')">
      <div class="nb-name">${s.name}</div>
      <div class="nb-meta">ğŸ¢ ${s.org_name||'â€”'}<br>ğŸ‘¥ ${s.waiting_count} waiting Â· â± ${s.time_interval} min/person${s.staff_name?`<br>ğŸ‘¤ ${s.staff_name}`:''}</div>
      <div class="nb-code">${s.service_code}</div>
    </div>`).join('');
}

function prefillCode(code) { show('join'); document.getElementById('code-in').value=code; findService(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveAccount() {
  const name  = document.getElementById('acc-name').value.trim();
  const phone = document.getElementById('acc-phone').value.trim();
  const lang  = document.getElementById('acc-lang').value;
  const r = await api('/api/user/profile', {method:'POST', body:{full_name:name, phone:phone, preferred_lang:lang}});
  if (!r.ok) { toast(r.data.error||'Save failed.','e'); return; }
  changeLang(lang);
  document.getElementById('lang-sel').value = lang;
  document.getElementById('tb-name').textContent = name || (profile&&profile.email) || 'â€”';
  toast('Account saved! âœ“', 's');
}

async function doLogout() {
  clearInterval(pollTimer);
  await api('/api/auth/logout', {method:'POST'});
  sessionStorage.clear();
  window.location.href = '/';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAQ AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FAQ_SYS = `You are QCode Assistant â€” the smart AI helper for QCode, a real-time digital queue management platform.

QCode lets users join queues via a service code (e.g. QC-ABC123). Organizations create queue services. Guests can join without an account. Users can also join via SMS.

Key features:
- Real-time position tracking
- End codes to verify completion of service
- Feedback after each queue
- Notifications before turn
- Auto-cancel if user doesn't respond within 25% of time interval
- Break times and schedules for services

Answer concisely and helpfully. Match the user's language.`;

function toggleFAQ() {
  const panel = document.getElementById('faq-panel');
  panel.classList.toggle('hidden');
  if (!panel.classList.contains('hidden')) document.getElementById('faq-inp').focus();
}

function quickQ(q) { document.getElementById('faq-inp').value = q; sendFAQ(); }

async function sendFAQ() {
  const inp = document.getElementById('faq-inp');
  const msg = inp.value.trim();
  if (!msg) return;
  inp.value = '';

  appendFAQ('user', msg);
  faqHistory.push({role:'user', content:msg});
  if (faqHistory.length > 20) faqHistory = faqHistory.slice(-20);

  const tid = 't-' + Date.now();
  appendFAQ('ai', '<span style="opacity:.5">Thinkingâ€¦</span>', tid);
  document.getElementById('faq-send').disabled = true;

  try {
    const res  = await fetch('/api/ai/faq', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({messages: faqHistory, system: FAQ_SYS})
    });
    const data = await res.json();
    const reply = data.response || 'Sorry, I could not respond right now.';
    faqHistory.push({role:'assistant', content:reply});
    const el = document.getElementById(tid);
    if (el) el.querySelector('.faq-bubble').innerHTML = reply.replace(/\n/g,'<br>');
    else appendFAQ('ai', reply);
  } catch(e) {
    const el = document.getElementById(tid);
    if (el) el.querySelector('.faq-bubble').innerHTML = 'âš ï¸ AI unavailable. Please try again.';
  } finally {
    document.getElementById('faq-send').disabled = false;
    document.getElementById('faq-inp').focus();
  }
}

function appendFAQ(role, text, id='') {
  const wrap = document.getElementById('faq-msgs');
  const div  = document.createElement('div');
  div.className = `faq-msg ${role}`;
  if (id) div.id = id;
  div.innerHTML = `<div class="faq-bubble">${typeof text==='string' ? text.replace(/\n/g,'<br>') : text}</div>`;
  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
}

function clearFAQ() {
  faqHistory = [];
  document.getElementById('faq-msgs').innerHTML = '<div class="faq-msg ai"><div class="faq-bubble">Chat cleared! How can I help?</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('code-in').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});
document.getElementById('code-in').addEventListener('keydown', e => { if(e.key==='Enter') findService(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
{% endraw %}
</body>
</html>
