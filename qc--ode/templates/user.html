<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>My Dashboard â€” QCode</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root{--navy:#0a1628;--blue:#1a3a6b;--accent:#2563eb;--cyan:#06b6d4;--s50:#f8fafc;--s100:#f1f5f9;--s200:#e2e8f0;--s300:#cbd5e1;--s400:#94a3b8;--s500:#64748b;--s700:#334155;--s900:#0f172a;--green:#22c55e;--gl:#dcfce7;--amber:#f59e0b;--al:#fef3c7;--red:#ef4444;--rl:#fee2e2;--fh:'Syne',sans-serif;--fb:'DM Sans',sans-serif;--r:.625rem;--rl2:1rem;--sh:0 1px 4px rgba(10,22,40,.08);--shm:0 4px 16px rgba(10,22,40,.10);--shl:0 12px 40px rgba(10,22,40,.15);--t:.18s cubic-bezier(.4,0,.2,1)}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--fb);background:var(--s50);color:var(--s900);min-height:100vh;display:flex;flex-direction:column}
    h1,h2,h3{font-family:var(--fh);line-height:1.2;letter-spacing:-.02em;color:var(--navy)}
    .topbar{background:var(--navy);height:60px;display:flex;align-items:center;padding:0 1.5rem;gap:1rem;flex-shrink:0;position:sticky;top:0;z-index:100}
    .tb-logo{display:flex;align-items:center;gap:.5rem;font-family:var(--fh);font-size:1.15rem;font-weight:800;color:#fff;text-decoration:none}
    .tb-logo span{color:var(--cyan)}
    .tb-right{margin-left:auto;display:flex;align-items:center;gap:.625rem}
    .tb-name{font-size:.825rem;color:rgba(255,255,255,.6);padding:.3rem .75rem;background:rgba(255,255,255,.08);border-radius:var(--r)}
    .tb-btn{background:none;border:none;cursor:pointer;padding:.4rem .875rem;border-radius:var(--r);font-family:var(--fb);font-size:.825rem;font-weight:500;color:rgba(255,255,255,.7);transition:all var(--t)}
    .tb-btn:hover{background:rgba(255,255,255,.1);color:#fff}
    .tb-logout{color:#f87171!important}.tb-logout:hover{background:rgba(239,68,68,.15)!important}
    .shell{display:flex;flex:1}
    .sidebar{width:240px;background:#fff;border-right:1px solid var(--s200);padding:1.25rem;flex-shrink:0;display:flex;flex-direction:column;gap:.2rem}
    .main{flex:1;padding:1.75rem;overflow-y:auto}
    .sb-section{font-size:.68rem;font-weight:700;color:var(--s400);text-transform:uppercase;letter-spacing:.1em;padding:.5rem .625rem;margin-top:.625rem}
    .sb-item{display:flex;align-items:center;gap:.625rem;padding:.625rem .875rem;border-radius:var(--r);font-size:.875rem;font-weight:500;color:var(--s700);cursor:pointer;border:none;background:none;width:100%;text-align:left;transition:all var(--t)}
    .sb-item:hover{background:var(--s100);color:var(--navy)}.sb-item.active{background:rgba(37,99,235,.08);color:var(--accent);font-weight:600}
    .panel{display:none}.panel.active{display:block}
    .profile-card{background:linear-gradient(135deg,var(--navy),var(--blue));border-radius:var(--rl2);padding:1.75rem;color:#fff;margin-bottom:1.5rem;display:flex;align-items:center;gap:1.25rem;flex-wrap:wrap}
    .avatar{width:56px;height:56px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-family:var(--fh);font-size:1.4rem;font-weight:800;flex-shrink:0;border:2.5px solid rgba(255,255,255,.3)}
    .pf-name{font-family:var(--fh);font-size:1.1rem;font-weight:700;margin-bottom:.2rem}
    .pf-email{font-size:.8rem;opacity:.65}
    .pf-stats{margin-left:auto;text-align:right}
    .pf-stat-n{font-family:var(--fh);font-size:1.5rem;font-weight:800}
    .pf-stat-l{font-size:.7rem;opacity:.6;text-transform:uppercase;letter-spacing:.06em}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:.55rem 1.25rem;border-radius:var(--r);border:none;font-family:var(--fb);font-size:.875rem;font-weight:600;cursor:pointer;transition:all var(--t);white-space:nowrap}
    .btn:disabled{opacity:.4;cursor:not-allowed}
    .bp{background:var(--accent);color:#fff}.bp:hover:not(:disabled){background:#1d4ed8}
    .bs{background:var(--green);color:#fff}.bs:hover:not(:disabled){filter:brightness(1.07)}
    .bd{background:var(--red);color:#fff}.bd:hover:not(:disabled){filter:brightness(1.07)}
    .bg{background:transparent;color:var(--s500);border:1.5px solid var(--s300)}.bg:hover:not(:disabled){border-color:var(--accent);color:var(--accent)}
    .btn-full{width:100%;display:flex}.btn-lg{padding:.875rem 2rem;font-size:1rem}
    .fg{display:flex;flex-direction:column;gap:.375rem;margin-bottom:1.125rem}
    .lbl{font-size:.82rem;font-weight:600;color:var(--s700)}.hint{font-size:.76rem;color:var(--s500)}
    .inp{padding:.75rem 1rem;background:var(--s50);border:1.5px solid var(--s300);border-radius:var(--r);font-family:var(--fb);font-size:.9rem;color:var(--s900);width:100%;transition:border-color var(--t),box-shadow var(--t)}
    .inp:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12);background:#fff}
    .inp::placeholder{color:var(--s300)}
    select.inp{cursor:pointer}
    .code-inp{text-transform:uppercase;letter-spacing:.12em;font-family:var(--fh);font-weight:700;font-size:1.1rem}
    .inp-row{display:flex;gap:.625rem}.inp-row .inp{flex:1}
    .ferr{font-size:.8rem;color:var(--red);margin-top:.3rem;display:none}
    .card{background:#fff;border:1px solid var(--s200);border-radius:var(--rl2);padding:1.75rem;box-shadow:var(--sh);margin-bottom:1.25rem}
    .card-title{font-family:var(--fh);font-size:1rem;font-weight:700;color:var(--navy);margin-bottom:1.25rem}
    .badge{display:inline-flex;align-items:center;padding:.2rem .65rem;border-radius:999px;font-size:.72rem;font-weight:700}
    .b-waiting{background:rgba(37,99,235,.1);color:var(--accent)}.b-called{background:var(--al);color:#92400e}
    .b-serving{background:var(--gl);color:#15803d}.b-completed{background:var(--s100);color:var(--s500)}
    .b-no_show{background:var(--rl);color:var(--red)}.b-cancelled{background:var(--s100);color:var(--s500)}
    .b-open{background:var(--gl);color:#15803d}.b-paused{background:var(--al);color:#92400e}.b-closed{background:var(--rl);color:var(--red)}
    .ticket-display{background:linear-gradient(135deg,var(--navy),var(--blue));border-radius:var(--rl2);color:#fff;text-align:center;padding:2.5rem 2rem;margin-bottom:1.25rem;position:relative;overflow:hidden}
    .td-bg{position:absolute;inset:0;opacity:.04;background:repeating-linear-gradient(-45deg,#fff,#fff 1px,transparent 1px,transparent 10px)}
    .td-inner{position:relative}
    .td-svc{font-size:.75rem;opacity:.6;text-transform:uppercase;letter-spacing:.1em;margin-bottom:.25rem}
    .td-lbl{font-size:.72rem;opacity:.6;text-transform:uppercase;letter-spacing:.1em}
    .td-num{font-family:var(--fh);font-size:5rem;font-weight:800;line-height:1;margin:.2rem 0}
    .td-pos{display:inline-flex;align-items:center;gap:.4rem;background:rgba(255,255,255,.15);border-radius:999px;padding:.375rem 1rem;font-size:.875rem;margin-top:1rem}
    .td-eta{display:inline-flex;align-items:center;gap:.375rem;background:rgba(6,182,212,.2);border:1px solid rgba(6,182,212,.3);border-radius:999px;padding:.375rem 1rem;font-size:.825rem;margin-top:.625rem;color:var(--cyan)}
    .status-box{border-radius:var(--rl2);padding:1.25rem 1.5rem;margin-bottom:1.25rem;border:2px solid transparent;transition:all .3s ease;display:flex;align-items:center;gap:1rem}
    .sb-waiting{background:rgba(37,99,235,.06);border-color:rgba(37,99,235,.15)}
    .sb-called{background:rgba(34,197,94,.08);border-color:var(--green);animation:pulseBorder 1.5s ease infinite}
    .sb-serving{background:var(--al);border-color:var(--amber)}
    @keyframes pulseBorder{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}50%{box-shadow:0 0 0 10px rgba(34,197,94,0)}}
    .sb-icon{font-size:2rem;flex-shrink:0}
    .sb-title{font-family:var(--fh);font-size:1rem;color:var(--navy)}
    .sb-desc{font-size:.825rem;color:var(--s500);margin-top:.2rem;line-height:1.5}
    .stat-pair{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem}
    .sp{background:var(--s50);border:1px solid var(--s200);border-radius:var(--r);padding:1rem;text-align:center}
    .sp-n{font-family:var(--fh);font-size:1.75rem;font-weight:800;color:var(--accent);line-height:1}
    .sp-l{font-size:.72rem;color:var(--s500);text-transform:uppercase;letter-spacing:.05em;margin-top:.2rem}
    .found-preview{background:rgba(37,99,235,.06);border:1px solid rgba(37,99,235,.2);border-radius:var(--r);padding:1rem 1.25rem;margin-bottom:1rem}
    .found-name{font-weight:700;color:var(--navy)}
    .found-meta{font-size:.78rem;color:var(--s500);margin-top:.25rem;display:flex;gap:1rem;flex-wrap:wrap}
    .custom-form{background:var(--s50);border:1px solid var(--s200);border-radius:var(--rl2);padding:1.25rem;margin-bottom:1.25rem}
    .custom-form h3{font-size:.9rem;margin-bottom:1rem;color:var(--navy)}
    .tbl-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    thead{border-bottom:2px solid var(--s200)}
    th{text-align:left;padding:.75rem 1rem;font-size:.72rem;font-weight:700;color:var(--s400);text-transform:uppercase;letter-spacing:.06em}
    td{padding:.875rem 1rem;font-size:.875rem;border-bottom:1px solid var(--s100);color:var(--s700)}
    tr:last-child td{border-bottom:none}tr:hover td{background:var(--s50)}
    .ticket-tag{font-family:var(--fh);font-size:.95rem;font-weight:700;color:var(--accent)}
    .nearby-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
    .nb-card{background:#fff;border:1px solid var(--s200);border-radius:var(--rl2);padding:1.25rem;cursor:pointer;transition:all var(--t)}
    .nb-card:hover{border-color:var(--accent);box-shadow:var(--shm)}
    .nb-name{font-weight:700;color:var(--navy);margin-bottom:.25rem}
    .nb-meta{font-size:.78rem;color:var(--s500);line-height:1.6}
    .nb-code{font-family:var(--fh);font-size:1.1rem;font-weight:800;color:var(--accent);letter-spacing:.1em;margin-top:.5rem}
    .empty{text-align:center;padding:3rem 2rem;color:var(--s500)}.empty h3{color:var(--s700);margin-bottom:.375rem}
    .spin{width:20px;height:20px;border:2.5px solid var(--s200);border-top-color:var(--accent);border-radius:50%;animation:spin .5s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:2.5rem;color:var(--s500)}
    #toasts{position:fixed;top:1.25rem;right:1.25rem;display:flex;flex-direction:column;gap:.625rem;z-index:999;pointer-events:none}
    .toast{padding:.75rem 1.125rem;border-radius:.5rem;box-shadow:var(--shl);font-size:.825rem;font-weight:500;display:flex;align-items:center;gap:.5rem;pointer-events:all;min-width:220px;animation:tIn .25s ease}
    .t-s{background:#f0fdf4;border-left:3px solid var(--green);color:#15803d}
    .t-e{background:#fef2f2;border-left:3px solid var(--red);color:#b91c1c}
    .t-i{background:#eff6ff;border-left:3px solid var(--accent);color:#1d4ed8}
    .t-w{background:#fffbeb;border-left:3px solid var(--amber);color:#92400e}
    @keyframes tIn{from{opacity:0;transform:translateX(1.5rem)}to{opacity:1;transform:translateX(0)}}
    @media(max-width:860px){.shell{flex-direction:column}.sidebar{width:100%;border-right:none;border-bottom:1px solid var(--s200);flex-direction:row;flex-wrap:wrap;padding:.75rem}}
    @media(max-width:640px){.main{padding:1rem}.td-num{font-size:3.5rem}}

     /* FAQ WIDGET */
    #faq-widget{position:fixed;bottom:2rem;right:2rem;z-index:500;}
    #faq-btn{display:flex;align-items:center;gap:0.5rem;background:var(--accent);color:#fff;border:none;border-radius:100px;padding:0.75rem 1.25rem;font-family:var(--fb);font-weight:700;font-size:0.9rem;cursor:pointer;box-shadow:0 4px 24px rgba(251,191,36,0.35);transition:all var(--t);}
    #faq-btn:hover{transform:translateY(-2px);box-shadow:0 6px 30px rgba(251,191,36,0.45);}
    .faq-panel{position:absolute;bottom:calc(100% + 1rem);right:0;width:370px;background:var(--card);border:1px solid var(--border);border-radius:var(--r-xl);box-shadow:0 8px 40px rgba(0,0,0,0.5);display:flex;flex-direction:column;overflow:hidden;max-height:510px;}
    .faq-panel.hidden{display:none;}
    .faq-hdr{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;background:var(--bg2);border-bottom:1px solid var(--border);}
    .faq-hdr-left{display:flex;align-items:center;gap:0.75rem;}
    .faq-av{font-size:1.5rem;}
    .faq-title{font-family:var(--fd);font-weight:700;font-size:0.92rem;}
    .faq-sub{font-size:0.7rem;color:var(--muted);}
    .faq-hdr-btns{display:flex;gap:0.4rem;}
    .faq-hdr-btns button{background:none;border:none;color:var(--muted);cursor:pointer;padding:0.25rem;border-radius:4px;font-size:0.95rem;transition:color var(--t);}
    .faq-hdr-btns button:hover{color:var(--text);}
    .faq-msgs{flex:1;padding:1rem;overflow-y:auto;display:flex;flex-direction:column;gap:0.75rem;min-height:220px;max-height:260px;}
    .faq-msg{display:flex;}
    .faq-msg.user{justify-content:flex-end;}
    .faq-bubble{max-width:85%;padding:0.65rem 0.9rem;border-radius:var(--r-md);font-size:0.875rem;line-height:1.55;}
    .faq-msg.ai .faq-bubble{background:var(--bg2);color:var(--text);border-bottom-left-radius:4px;}
    .faq-msg.user .faq-bubble{background:var(--accent);color:#0a0a0f;font-weight:500;border-bottom-right-radius:4px;}
    .typing{animation:tpulse 1.2s infinite;}
    @keyframes tpulse{0%,100%{opacity:1;}50%{opacity:0.35;}}
    .faq-quickbtns{display:flex;gap:0.4rem;padding:0.5rem 1rem;flex-wrap:wrap;border-top:1px solid var(--border);}
    .faq-quickbtns button{background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:0.28rem 0.65rem;border-radius:100px;font-size:0.73rem;cursor:pointer;transition:all var(--t);font-family:var(--fb);}
    .faq-quickbtns button:hover{border-color:var(--accent);color:var(--accent);}
    .faq-input-row{display:flex;gap:0.5rem;padding:0.75rem 1rem;border-top:1px solid var(--border);}
    .faq-input-row input{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r-md);padding:0.5rem 0.75rem;font-size:0.875rem;color:var(--text);font-family:var(--fb);outline:none;transition:border-color var(--t);}
    .faq-input-row input:focus{border-color:var(--accent);}
    #faq-send{background:var(--accent);color:#0a0a0f;border:none;border-radius:var(--r-md);width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all var(--t);}
    #faq-send:hover{background:#f59e0b;}
    #faq-send:disabled{opacity:0.5;}

    @media(max-width:900px){.layout{grid-template-columns:1fr;}}
    @media(max-width:600px){.code-row{flex-direction:column;}.aq-row{flex-direction:column;}.meta-grid{grid-template-columns:repeat(2,1fr);}.faq-panel{width:calc(100vw - 3rem);right:-1rem;}}
  </style>
</head>
<body>
<div class="topbar">
  <a href="/" class="tb-logo"><svg width="26" height="26" viewBox="0 0 30 30" fill="none"><rect width="30" height="30" rx="7" fill="#2563eb"/><rect x="8" y="9" width="14" height="3" rx="1.5" fill="white"/><rect x="8" y="14" width="10" height="3" rx="1.5" fill="#93c5fd"/><rect x="8" y="19" width="6" height="3" rx="1.5" fill="#60a5fa"/></svg><span>Q</span>Code</a>
  <div class="tb-right">
    <span class="tb-name" id="tb-name">â€”</span>
    <select style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.7);border-radius:var(--r);padding:.3rem .5rem;font-size:.75rem;cursor:pointer" onchange="changeLang(this.value)" id="lang-sel">
      <option value="en">EN</option><option value="fr">FR</option><option value="ar">AR</option><option value="es">ES</option><option value="pt">PT</option>
    </select>
    <button class="tb-btn tb-logout" onclick="doLogout()">Logout</button>
  </div>
</div>
<div class="shell">
  <div class="sidebar">
    <div class="sb-section">My Queue</div>
    <button class="sb-item active" onclick="show('join')"    id="nav-join">  <span>ğŸ«</span> Join Queue</button>
    <button class="sb-item"        onclick="show('active')"  id="nav-active"><span>ğŸ“¡</span> Active Queue</button>
    <div class="sb-section">History</div>
    <button class="sb-item" onclick="show('history')" id="nav-history"><span>ğŸ•</span> My History</button>
    <button class="sb-item" onclick="show('nearby')"  id="nav-nearby"> <span>ğŸ—º</span> Open Services</button>
    <div class="sb-section">Account</div>
    <button class="sb-item" onclick="show('account')" id="nav-account"><span>ğŸ‘¤</span> Account</button>
  </div>
  <div class="main">

    <!-- JOIN -->
    <div class="panel active" id="panel-join">
      <div style="margin-bottom:1.5rem"><h1>Join a Queue</h1><p style="color:var(--s500);margin-top:.25rem">Enter the service code given to you</p></div>
      <div class="card">
        <div class="card-title">ğŸ« Service Code</div>
        <div id="step-code">
          <div class="inp-row">
            <input id="code-in" class="inp code-inp" type="text" placeholder="e.g. VISA24" maxlength="8"/>
            <button class="btn bp" onclick="findService()">Find</button>
          </div>
          <span id="code-err" class="ferr"></span>
        </div>
        <div id="step-found" style="display:none;margin-top:1.25rem">
          <div class="found-preview">
            <div class="found-name" id="found-name"></div>
            <div class="found-meta"><span id="found-staff-meta"></span><span id="found-eta-meta"></span><span id="found-waiting-meta"></span></div>
          </div>
          <div id="custom-form-wrap" style="display:none" class="custom-form"><h3>Please fill in the required information</h3><div id="custom-form-fields"></div></div>
          <button class="btn bs btn-full btn-lg" onclick="confirmJoin()">Join This Queue</button>
          <button class="btn bg btn-full" onclick="cancelFind()" style="margin-top:.625rem">Cancel</button>
        </div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,rgba(6,182,212,.06),rgba(37,99,235,.04));border-color:rgba(6,182,212,.2)">
        <div style="display:flex;align-items:center;gap:1rem">
          <div style="font-size:2rem">ğŸ“±</div>
          <div><div style="font-weight:700;color:var(--navy);margin-bottom:.25rem">Join by SMS â€” no internet needed</div>
          <div style="font-size:.825rem;color:var(--s500);line-height:1.5">Text your service code to <strong id="sms-num" style="color:var(--accent)">+0000000000</strong> to get your ticket instantly.</div></div>
        </div>
      </div>
    </div>

    <!-- ACTIVE -->
    <div class="panel" id="panel-active">
      <div style="margin-bottom:1.5rem"><h1>Active Queue</h1><p style="color:var(--s500);margin-top:.25rem">Your real-time position and wait time</p></div>
      <div id="no-active-queue" class="card"><div class="empty"><div style="font-size:3rem;margin-bottom:.75rem">â°</div><h3>Not in any queue</h3><p>Use "Join Queue" to enter a service code and join.</p></div></div>
      <div id="active-queue-view" style="display:none">
        <div style="background:var(--navy);border-radius:var(--rl2);padding:1.125rem 1.5rem;margin-bottom:1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem">
          <div><div style="font-family:var(--fh);font-size:1.05rem;font-weight:700;color:#fff" id="a-svc-name">â€”</div><div style="font-size:.78rem;color:rgba(255,255,255,.55);margin-top:.125rem" id="a-org-name">â€”</div></div>
          <span class="badge" id="a-svc-status"></span>
        </div>
        <div class="status-box sb-waiting" id="status-box">
          <div class="sb-icon" id="sb-icon">â³</div>
          <div><div class="sb-title" id="sb-title">Waiting in queue</div><div class="sb-desc" id="sb-desc">Your position updates automatically. Stay nearby.</div></div>
        </div>
        <div class="ticket-display">
          <div class="td-bg"></div>
          <div class="td-inner">
            <div class="td-svc" id="td-svc-name"></div>
            <div class="td-lbl">Your Ticket</div>
            <div class="td-num" id="td-num">â€”</div>
            <div><span class="td-pos">Position <strong id="td-pos" style="margin-left:.375rem">â€”</strong></span></div>
            <div><span class="td-eta" id="td-eta">Calculating ETAâ€¦</span></div>
          </div>
        </div>
        <div class="stat-pair">
          <div class="sp"><div class="sp-n" id="sp-ahead">â€”</div><div class="sp-l">Ahead of You</div></div>
          <div class="sp"><div class="sp-n" id="sp-waiting">â€”</div><div class="sp-l">Total Waiting</div></div>
        </div>
        <button class="btn bd btn-full btn-lg" id="leave-btn" onclick="leaveQueue()">Leave Queue</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="panel" id="panel-history">
      <div style="margin-bottom:1.5rem"><h1>My History</h1><p style="color:var(--s500);margin-top:.25rem">Every queue you have ever joined</p></div>
      <div class="card"><div class="tbl-wrap"><table>
        <thead><tr><th>Ticket</th><th>Service</th><th>Organization</th><th>Method</th><th>Status</th><th>Joined</th></tr></thead>
        <tbody id="hist-tbody"><tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--s400)">Loadingâ€¦</td></tr></tbody>
      </table></div></div>
    </div>

    <!-- NEARBY -->
    <div class="panel" id="panel-nearby">
      <div style="margin-bottom:1.5rem"><h1>Open Services</h1><p style="color:var(--s500);margin-top:.25rem">All live queues you can join right now</p></div>
      <div id="nearby-grid" class="nearby-grid"><div class="loading"><div class="spin"></div> Loadingâ€¦</div></div>
    </div>
        
<!-- FAQ WIDGET -->
<div id="faq-widget">
  <button id="faq-btn" onclick="toggleFAQ()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    Ask AI
  </button>
  <div class="faq-panel hidden" id="faq-panel">
    <div class="faq-hdr">
      <div class="faq-hdr-left">
        <div class="faq-av">ğŸ¤–</div>
        <div><div class="faq-title">QCode Assistant</div><div class="faq-sub">Powered by Llama AI Â· Always online</div></div>
      </div>
      <div class="faq-hdr-btns">
        <button onclick="clearChat()" title="Clear">â†º</button>
        <button onclick="toggleFAQ()" title="Close">âœ•</button>
      </div>
    </div>
    <div class="faq-msgs" id="faq-msgs">
      <div class="faq-msg ai"><div class="faq-bubble">ğŸ‘‹ Hi! I'm your QCode Assistant. I can help with:<br><br>â€¢ Joining a queue with a service code<br>â€¢ Understanding your queue position &amp; time<br>â€¢ Organization registration &amp; approval<br>â€¢ SMS queue joining<br><br>What can I help with?</div></div>
    </div>
    <div class="faq-quickbtns">
      <button onclick="quickQ('How do I join a queue?')">How to join</button>
      <button onclick="quickQ('What is a service code?')">Service codes</button>
      <button onclick="quickQ('How does SMS queue joining work?')">SMS joining</button>
    </div>
    <div class="faq-input-row">
      <input type="text" id="faq-inp" placeholder="Type your question..." onkeydown="if(event.key==='Enter')sendFAQ()" />
      <button id="faq-send" onclick="sendFAQ()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>
    <!-- ACCOUNT -->
    <div class="panel" id="panel-account">
      <div style="margin-bottom:1.5rem"><h1>My Account</h1></div>
      <div class="profile-card" id="profile-card"></div>
      <div class="card" style="max-width:520px">
        <div class="card-title">Settings</div>
        <div class="fg"><label class="lbl">Full Name</label><input id="acc-name" class="inp" type="text"/></div>
        <div class="fg"><label class="lbl">Phone Number</label><input id="acc-phone" class="inp" type="tel" placeholder="+1 234 567 8900"/><span class="hint">For SMS queue updates</span></div>
        <div class="fg"><label class="lbl">Preferred Language</label>
          <select id="acc-lang" class="inp">
            <option value="en">English</option><option value="fr">Francais</option><option value="ar">Arabic</option><option value="es">Espanol</option><option value="pt">Portugues</option>
          </select>
        </div>
        <button class="btn bp" onclick="saveAccount()">Save Changes</button>
      </div>
    </div>

  </div>
</div>
<div id="toasts"></div>
<script>
// â”€â”€ API helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(url, opts) {
  try {
    const r = await fetch(url, {
      headers: {'Content-Type': 'application/json'},
      ...opts,
      body: opts && opts.body && typeof opts.body === 'object' ? JSON.stringify(opts.body) : (opts && opts.body),
    });
    const data = await r.json().catch(() => ({}));
    return {ok: r.ok, status: r.status, data};
  } catch(e) {
    return {ok: false, status: 0, data: {error: 'Network error. Please check your connection.'}};
  }
}

function toast(msg, type, ms) {
  type = type || 'i'; ms = ms || 4500;
  var icons = {s:'âœ“', e:'âœ•', i:'â„¹', w:'âš '};
  var el = document.createElement('div');
  el.className = 'toast t-' + type;
  el.innerHTML = '<span>' + (icons[type]||'â„¹') + '</span><span>' + msg + '</span>';
  document.getElementById('toasts').appendChild(el);
  setTimeout(function(){ el.remove(); }, ms);
}

function fmt(ts) { if(!ts) return 'â€”'; var d=new Date(ts); return d.toLocaleDateString()+' '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function badge(s) { var m={waiting:'b-waiting',called:'b-called',serving:'b-serving',completed:'b-completed',no_show:'b-no_show',cancelled:'b-cancelled'}; return '<span class="badge '+(m[s]||'')+'">'+(s||'').replace('_',' ')+'</span>'; }
function changeLang(l) { localStorage.setItem('qcode_lang',l); document.documentElement.lang=l; document.documentElement.dir=l==='ar'?'rtl':'ltr'; }

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var profile = null;
var activeEntry = null;
var pollTimer = null;
var foundSvc = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  var session = await api('/api/auth/me');
  if (!session.ok || !session.data.logged_in) { window.location.href = '/auth/login-user'; return; }
  if (session.data.role !== 'user') {
    window.location.href = session.data.role === 'organization' ? '/dashboard/org' : '/admin';
    return;
  }
  var pr = await api('/api/user/profile');
  if (!pr.ok) { window.location.href = '/login-user'; return; }
  profile = pr.data;

  document.getElementById('tb-name').textContent = profile.full_name || profile.email || 'â€”';
  document.getElementById('acc-name').value  = profile.full_name  || '';
  document.getElementById('acc-phone').value = profile.phone      || '';
  document.getElementById('acc-lang').value  = profile.preferred_lang || 'en';

  var lang = profile.preferred_lang || localStorage.getItem('qcode_lang') || 'en';
  changeLang(lang);
  document.getElementById('lang-sel').value = lang;

  var initials = (profile.full_name || profile.email || 'U').split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
  document.getElementById('profile-card').innerHTML =
    '<div class="avatar">'+initials+'</div>' +
    '<div><div class="pf-name">'+(profile.full_name || profile.email)+'</div>' +
    '<div class="pf-email">'+profile.email+'</div>' +
    (profile.phone ? '<div class="pf-email">ğŸ“ '+profile.phone+'</div>' : '') + '</div>' +
    '<div class="pf-stats"><div class="pf-stat-n">'+(profile.total_queues||0)+'</div><div class="pf-stat-l">Total Queues</div></div>';

  await loadHistory();
}

// â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(name) {
  document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.sb-item').forEach(function(b){b.classList.remove('active');});
  document.getElementById('panel-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if (name==='history') loadHistory();
  if (name==='nearby')  loadNearby();
}

// â”€â”€ Find service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function findService() {
  var code = document.getElementById('code-in').value.trim().toUpperCase();
  var err  = document.getElementById('code-err');
  err.style.display = 'none';
  if (!code) { err.textContent='Please enter a service code.'; err.style.display='block'; return; }
  var r = await api('/api/user/find-service?code=' + encodeURIComponent(code));
  if (!r.ok) { err.textContent = r.data.error || 'Service not found.'; err.style.display='block'; return; }
  foundSvc = r.data;
  document.getElementById('found-name').textContent        = r.data.name;
  document.getElementById('found-staff-meta').textContent  = r.data.staff_name ? 'ğŸ‘¤ '+r.data.staff_name : '';
  document.getElementById('found-eta-meta').textContent    = 'â± ~'+r.data.eta_minutes+' min wait';
  document.getElementById('found-waiting-meta').textContent= 'ğŸ‘¥ '+r.data.waiting_count+' waiting';
  document.getElementById('step-code').style.display  = 'none';
  document.getElementById('step-found').style.display = 'block';

  var fields = [];
  try { fields = JSON.parse(r.data.user_info_form || '[]'); } catch(e) {}
  if (fields.length) {
    document.getElementById('custom-form-wrap').style.display = 'block';
    document.getElementById('custom-form-fields').innerHTML = fields.map(function(f) {
      return '<div class="fg"><label class="lbl">'+f.label+(f.required?' *':'')+'</label>' +
        (f.type==='textarea' ? '<textarea id="cf-'+f.id+'" class="inp" rows="3"></textarea>' :
         f.type==='select'   ? '<select id="cf-'+f.id+'" class="inp"><option value="">Selectâ€¦</option>'+(f.options||[]).map(function(o){return '<option>'+o+'</option>';}).join('')+'</select>' :
                                '<input id="cf-'+f.id+'" class="inp" type="'+(f.type||'text')+'"/>') +
        '</div>';
    }).join('');
  }
}

function cancelFind() {
  foundSvc = null;
  document.getElementById('step-found').style.display = 'none';
  document.getElementById('step-code').style.display  = 'block';
  document.getElementById('code-in').value            = '';
  document.getElementById('custom-form-wrap').style.display = 'none';
}

async function confirmJoin() {
  if (!foundSvc) return;
  var formData = {};
  try {
    var fields = JSON.parse(foundSvc.user_info_form || '[]');
    for (var i=0; i<fields.length; i++) {
      var f = fields[i];
      var el = document.getElementById('cf-'+f.id);
      if (!el) continue;
      if (f.required && !el.value) { toast('"'+f.label+'" is required.', 'e'); return; }
      formData[f.id] = {label: f.label, value: el.value};
    }
  } catch(e) {}
  var r = await api('/api/user/join-queue', {method:'POST', body:{service_id: foundSvc.id, custom_form_data: formData}});
  if (!r.ok) { toast(r.data.error || 'Failed to join queue.', 'e'); return; }
  activeEntry = r.data.entry;
  cancelFind();
  renderActive();
  show('active');
  toast("You've joined the queue!", 's');
  startPolling();
}

// â”€â”€ Active queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderActive() {
  if (!activeEntry) return;
  document.getElementById('no-active-queue').style.display   = 'none';
  document.getElementById('active-queue-view').style.display = 'block';
  document.getElementById('a-svc-name').textContent  = activeEntry.svc_name  || 'â€”';
  document.getElementById('a-org-name').textContent  = activeEntry.org_name  || '';
  document.getElementById('td-svc-name').textContent = activeEntry.svc_name  || '';
  document.getElementById('td-num').textContent      = activeEntry.ticket_label;
  var sb = document.getElementById('a-svc-status');
  sb.textContent = activeEntry.svc_status || '';
  sb.className   = 'badge b-'+(activeEntry.svc_status||'');
  refreshStatus();
}

async function refreshStatus() {
  if (!activeEntry) return;
  var r = await api('/api/user/queue-status/' + activeEntry.id);
  if (!r.ok) return;
  var d = r.data;
  if (['completed','cancelled','no_show'].includes(d.status)) {
    clearInterval(pollTimer); activeEntry = null;
    document.getElementById('no-active-queue').style.display   = 'block';
    document.getElementById('active-queue-view').style.display = 'none';
    toast('Your queue session has ended.', 'i');
    return;
  }
  var pos = d.position || 1;
  document.getElementById('td-pos').textContent    = pos;
  document.getElementById('sp-ahead').textContent  = Math.max(0, pos-1);
  document.getElementById('sp-waiting').textContent= d.total || 0;
  document.getElementById('td-eta').textContent    = 'â± ~'+(d.eta_minutes||0)+' min';
  var box   = document.getElementById('status-box');
  var icon  = document.getElementById('sb-icon');
  var title = document.getElementById('sb-title');
  var desc  = document.getElementById('sb-desc');
  box.className = 'status-box';
  if (d.status === 'called') {
    box.classList.add('sb-called'); icon.textContent='ğŸ“¢'; title.textContent="You're being called!"; desc.textContent='Please proceed to the counter immediately!';
    toast('ğŸ“¢ You are being called! Go to the counter NOW.', 'w', 9000);
  } else if (d.status === 'serving') {
    box.classList.add('sb-serving'); icon.textContent='âœ…'; title.textContent='Being served'; desc.textContent='You are currently at the counter.';
  } else {
    box.classList.add('sb-waiting');
    if (pos===1)     { icon.textContent='ğŸ””'; title.textContent="You're next!"; desc.textContent='You will be called very soon.'; }
    else if (pos<=3) { icon.textContent='â°'; title.textContent='Nearly your turn'; desc.textContent='Only a few people ahead of you.'; }
    else             { icon.textContent='â³'; title.textContent='Waiting in queue'; desc.textContent='Your position updates automatically.'; }
  }
}

function startPolling() {
  clearInterval(pollTimer);
  pollTimer = setInterval(refreshStatus, 15000);
}

async function leaveQueue() {
  if (!activeEntry || !confirm('Leave this queue?')) return;
  document.getElementById('leave-btn').disabled = true;
  var r = await api('/api/user/leave-queue/'+activeEntry.id, {method:'POST'});
  if (!r.ok) { toast(r.data.error||'Error leaving queue.','e'); document.getElementById('leave-btn').disabled=false; return; }
  clearInterval(pollTimer); activeEntry = null;
  document.getElementById('no-active-queue').style.display   = 'block';
  document.getElementById('active-queue-view').style.display = 'none';
  document.getElementById('leave-btn').disabled = false;
  toast('You have left the queue.', 'i');
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  var r = await api('/api/user/history');
  var tb = document.getElementById('hist-tbody');
  if (!r.ok || !r.data.length) { tb.innerHTML='<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--s400)">No history yet.</td></tr>'; return; }
  tb.innerHTML = r.data.map(function(e) {
    return '<tr><td><span class="ticket-tag">'+(e.ticket_label||'â€”')+'</span></td>' +
      '<td>'+(e.svc_name||'â€”')+'</td><td>'+(e.org_name||'â€”')+'</td>' +
      '<td>'+(e.join_method==='sms'?'ğŸ“± SMS':'ğŸŒ Web')+'</td>' +
      '<td>'+badge(e.status)+'</td>' +
      '<td style="font-size:.8rem">'+fmt(e.joined_at)+'</td></tr>';
  }).join('');
}

// â”€â”€ Open Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadNearby() {
  var r = await api('/api/user/open-services');
  var grid = document.getElementById('nearby-grid');
  if (!r.ok || !r.data.length) { grid.innerHTML='<div class="empty"><h3>No open services right now</h3><p>Check back later or ask for a service code.</p></div>'; return; }
  grid.innerHTML = r.data.map(function(s) {
    return '<div class="nb-card" onclick="prefillCode(\''+s.service_code+'\')">' +
      '<div class="nb-name">'+s.name+'</div>' +
      '<div class="nb-meta">ğŸ¢ '+(s.org_name||'â€”')+'<br>ğŸ‘¥ '+s.waiting_count+' waiting Â· â± '+s.time_interval+' min/person'+(s.staff_name?'<br>ğŸ‘¤ '+s.staff_name:'')+'</div>' +
      '<div class="nb-code">'+s.service_code+'</div></div>';
  }).join('');
}

function prefillCode(code) { show('join'); document.getElementById('code-in').value=code; findService(); }

// â”€â”€ Account â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAccount() {
  var name  = document.getElementById('acc-name').value.trim();
  var phone = document.getElementById('acc-phone').value.trim();
  var lang  = document.getElementById('acc-lang').value;
  var r = await api('/api/user/profile', {method:'POST', body:{full_name:name, phone:phone, preferred_lang:lang}});
  if (!r.ok) { toast(r.data.error||'Save failed.','e'); return; }
  changeLang(lang);
  document.getElementById('lang-sel').value = lang;
  document.getElementById('tb-name').textContent = name || (profile && profile.email) || 'â€”';
  toast('Account saved!', 's');
}
 // â”€â”€ FAQ AI â”€â”€
  const FAQ_SYS=`You are QCode Assistant, the helpful AI for QCode â€” a digital queue management platform used globally.
QCode lets users join queues at organizations using a service code (e.g. QC-ABC123). Organizations create queue services. Guests can join without an account. Users can also join via SMS by texting the service code.
Answer questions helpfully and concisely. Respond in the user's language if they write in another language.`;

  function toggleFAQ(){
    document.getElementById('faq-panel').classList.toggle('hidden');
    if(!document.getElementById('faq-panel').classList.contains('hidden')){
      document.getElementById('faq-inp')?.focus();
    }
  }

  function quickQ(q){document.getElementById('faq-inp').value=q;sendFAQ();}

  async function sendFAQ(){
    const inp=document.getElementById('faq-inp');
    const msg=inp.value.trim();
    if(!msg) return;
    inp.value='';

    appendMsg('user',msg);
    faqHistory.push({role:'user',content:msg});
    if(faqHistory.length>20) faqHistory=faqHistory.slice(-20);

    const typingId='t-'+Date.now();
    appendMsg('ai','Thinking...','typing',typingId);
    document.getElementById('faq-send').disabled=true;

    try{
      const res=await fetch(GROQ_API_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({messages:faqHistory,system:FAQ_SYS})
      });
      const data=await res.json();
      const reply=data.response||'Sorry, I could not get a response. Please try again.';
      faqHistory.push({role:'assistant',content:reply});
      document.getElementById(typingId)?.remove();
      appendMsg('ai',reply);
    }catch(e){
      document.getElementById(typingId)?.remove();
      appendMsg('ai','âš ï¸ AI assistant is temporarily unavailable. Please try again shortly.');
    }finally{
      document.getElementById('faq-send').disabled=false;
      inp.focus();
    }
  }

  function appendMsg(role,text,cls='',id=''){
    const wrap=document.getElementById('faq-msgs');
    const div=document.createElement('div');
    div.className='faq-msg '+role;
    if(id) div.id=id;
    div.innerHTML=`<div class="faq-bubble${cls?' '+cls:''}">${text.replace(/\n/g,'<br>')}</div>`;
    wrap.appendChild(div);
    wrap.scrollTop=wrap.scrollHeight;
    return div.id;
  }

  function clearChat(){
    faqHistory=[];
    document.getElementById('faq-msgs').innerHTML='<div class="faq-msg ai"><div class="faq-bubble">Chat cleared! How can I help you?</div></div>';
  }

async function doLogout() {
  clearInterval(pollTimer);
  await api('/api/auth/logout', {method:'POST'});
  window.location.href = '/';
}

document.getElementById('code-in').addEventListener('keydown', function(e){ if(e.key==='Enter') findService(); });
init();
</script>
</body>
</html>
